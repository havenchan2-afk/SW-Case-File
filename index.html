<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Case Manager - Advanced Import</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --success: #34c759; --warning: #ff9500; --danger: #ff3b30; --bg-gray: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-sec: #8e8e93; --alert-bg: #ffe2e6; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-gray); margin: 0; padding-bottom: 50px; color: var(--text-main); }
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        .io-controls { background: #fff; padding: 10px 20px; display: flex; gap: 10px; border-bottom: 1px solid #e5e5ea; }
        .btn-io { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .controls { background: white; padding: 10px 20px 5px 20px; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d1d6; box-sizing: border-box; margin-bottom: 10px; }
        #case-list { padding: 16px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; }
        .card.urgent-alert { background-color: var(--alert-bg); }
        .card-content { flex: 1; }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-right: 5px; }
        .modal-overlay { position: fixed; top:0; left:0; width: 100%; height:100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 600px; height: 95%; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        input, textarea { width: 100%; padding: 11px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .log-item { background: #f9f9fb; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #ddd; position: relative; }
        .btn-full { width: 100%; padding: 16px; border-radius: 14px; font-weight: bold; cursor: pointer; border: none; margin-bottom: 12px; }
        .opt-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #f2f2f7; cursor: pointer; text-align: center; font-size: 13px; }
        .opt-btn.active { background: var(--primary); color: white; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<header>
    <h1>Case Manager</h1>
    <button style="background:none; border:none; color:var(--primary); font-size:30px;" onclick="openAddModal()">ï¼‹</button>
</header>

<div class="io-controls">
    <button class="btn-io" onclick="exportToExcel()">ğŸ“¤ å…¨é«”åŒ¯å‡º</button>
    <button class="btn-io" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥ Excel (å«ç´€éŒ„)</button>
    <input type="file" id="importFile" hidden accept=".xlsx" onchange="importFromExcel(event)">
</div>

<div class="controls">
    <input type="text" class="search-input" id="search-box" placeholder="ğŸ” æœå°‹..." oninput="renderCases()">
</div>

<div id="case-list"></div>

<div class="modal-overlay" id="case-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>å€‹æ¡ˆè©³æƒ…</h2>
            <button onclick="closeModal()" style="border:none; background:none; color:var(--primary);">é—œé–‰</button>
        </div>
        <input type="hidden" id="internal-id">
        <input type="hidden" id="editing-log-index" value="-1">
        
        <div class="form-group"><label>å€‹æ¡ˆç·¨è™Ÿ</label><input type="text" id="f-case-no"></div>
        <div class="form-group"><label>å§“å</label><input type="text" id="f-name"></div>

        <div style="background:#eee; height:1px; margin:20px 0;"></div>

        <div class="form-group" id="log-input-section">
            <label id="log-input-label">æ–°å¢/ä¿®æ”¹ç´€éŒ„</label>
            <input type="date" id="log-date" style="margin-bottom:10px;">
            <div class="option-grid">
                <div class="opt-btn" id="lt-Phone" onclick="setLogType('Phone')">ğŸ“ é›»è©±</div>
                <div class="opt-btn" id="lt-InPerson" onclick="setLogType('InPerson')">ğŸ«‚ é¢è¦‹</div>
            </div>
            <textarea id="log-text" placeholder="ç´€éŒ„å…§å®¹..." rows="3"></textarea>
            <button id="save-log-btn" onclick="saveLogEntry()" style="width:100%; margin-top:10px; background:var(--success); color:white; border:none; padding:12px; border-radius:10px;">å„²å­˜ç´€éŒ„</button>
        </div>

        <div id="modal-log-list"></div>
        <button class="btn-full" style="background:var(--primary); color:white; margin-top:20px;" onclick="saveFullCase()">å„²å­˜ä¸¦é€€å‡º</button>
    </div>
</div>

<script>
    let cases = JSON.parse(localStorage.getItem('elderly_cases_v10')) || [];
    let tempLogType = 'Phone';

    function saveToLocal() { localStorage.setItem('elderly_cases_v10', JSON.stringify(cases)); }

    // --- æ ¸å¿ƒï¼šå¼·åŒ–çš„åŒ¯å…¥åŠŸèƒ½ ---
    function importFromExcel(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

            json.forEach(row => {
                const caseNo = String(row["å€‹æ¡ˆç·¨è™Ÿ"] || "").trim();
                const name = String(row["å§“å"] || "æœªå‘½å").trim();
                const logDate = row["ç´€éŒ„æ—¥æœŸ"];
                const logNote = row["ç´€éŒ„å…§å®¹"];
                const logTypeStr = row["è¯çµ¡æ–¹å¼"];

                if (!caseNo) return;

                // 1. å°‹æ‰¾æˆ–å»ºç«‹å€‹æ¡ˆ
                let targetCase = cases.find(c => c.caseNo === caseNo);
                if (!targetCase) {
                    targetCase = {
                        id: Date.now().toString() + Math.random(),
                        caseNo: caseNo,
                        name: name,
                        status: "Active",
                        priority: "Normal",
                        caseType: "Counselling",
                        lastContactDate: "",
                        contactLog: [],
                        isPinned: false
                    };
                    cases.push(targetCase);
                }

                // 2. å¦‚æœ Excel è£¡æœ‰ç´€éŒ„è³‡æ–™ï¼Œå‰‡åŒ¯å…¥
                if (logDate && logNote) {
                    // æª¢æŸ¥æ˜¯å¦å·²æœ‰é‡è¤‡ç´€éŒ„ï¼ˆé˜²æ­¢é‡è¤‡åŒ¯å…¥åŒä¸€ä»½æª”æ¡ˆï¼‰
                    const isDuplicate = targetCase.contactLog.some(l => l.date === String(logDate) && l.note === String(logNote));
                    
                    if (!isDuplicate) {
                        targetCase.contactLog.push({
                            date: String(logDate),
                            note: String(logNote),
                            type: (logTypeStr === "é¢è¦‹") ? "InPerson" : "Phone"
                        });
                    }
                }

                // 3. æ›´æ–°è©²å€‹æ¡ˆçš„æœ€å¾Œè¯çµ¡æ—¥æœŸ
                if (targetCase.contactLog.length > 0) {
                    targetCase.lastContactDate = targetCase.contactLog.reduce((max, p) => p.date > max ? p.date : max, "");
                }
            });

            saveToLocal();
            renderCases();
            alert("åŒ¯å…¥æˆåŠŸï¼ç³»çµ±å·²è‡ªå‹•å°æ‡‰ç·¨è™Ÿä¸¦æ›´æ–°ç´€éŒ„ã€‚");
            event.target.value = ''; // æ¸…ç©º file input
        };
        reader.readAsArrayBuffer(file);
    }

    // --- åŸºç¤æ¸²æŸ“é‚è¼¯ ---
    function renderCases() {
        const list = document.getElementById('case-list');
        list.innerHTML = cases.map(c => `
            <div class="card" onclick="openEditModal('${c.id}')">
                <div class="card-content">
                    <div style="font-size:11px; color:var(--primary); font-weight:bold;">${c.caseNo}</div>
                    <div style="font-weight:bold;">${c.name}</div>
                    <div style="font-size:11px; color:#888;">ç´€éŒ„æ•¸: ${c.contactLog.length} | æœ€å¾Œè¯çµ¡: ${c.lastContactDate || 'ç„¡'}</div>
                </div>
            </div>
        `).join('');
    }

    function openEditModal(id) {
        const c = cases.find(x => x.id === id);
        document.getElementById('internal-id').value = c.id;
        document.getElementById('f-case-no').value = c.caseNo;
        document.getElementById('f-name').value = c.name;
        renderLogs(c.contactLog);
        document.getElementById('case-modal').style.display = 'flex';
    }

    function renderLogs(logs) {
        document.getElementById('modal-log-list').innerHTML = (logs || []).map((l, idx) => `
            <div class="log-item">
                <small>${l.date} | ${l.type === 'Phone' ? 'ğŸ“' : 'ğŸ«‚'}</small>
                <div>${l.note}</div>
            </div>
        `).reverse().join('');
    }

    function saveLogEntry() {
        const id = document.getElementById('internal-id').value;
        const note = document.getElementById('log-text').value;
        const date = document.getElementById('log-date').value;
        const idx = cases.findIndex(x => x.id === id);
        cases[idx].contactLog.push({ date, note, type: tempLogType });
        cases[idx].lastContactDate = date;
        saveToLocal();
        renderLogs(cases[idx].contactLog);
        document.getElementById('log-text').value = '';
    }

    function setLogType(t) { tempLogType = t; document.getElementById('lt-Phone').classList.toggle('active', t==='Phone'); document.getElementById('lt-InPerson').classList.toggle('active', t==='InPerson'); }
    function openAddModal() { /* æ¸…ç©ºä¸¦æ‰“é–‹ */ document.getElementById('case-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('case-modal').style.display = 'none'; }
    function saveFullCase() { /* å„²å­˜é‚è¼¯ */ saveToLocal(); renderCases(); closeModal(); }
    function exportToExcel() { /* ä¿æŒåŸæœ‰çš„åŒ¯å‡ºé‚è¼¯ */ }
</script>
</body>
</html>

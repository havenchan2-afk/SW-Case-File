<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Case Manager - Excel Pro</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #007AFF; --success: #34c759; --warning: #ff9500; --danger: #ff3b30;
            --bg-gray: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-sec: #8e8e93;
        }

        body { font-family: -apple-system, sans-serif; background-color: var(--bg-gray); margin: 0; padding-bottom: 50px; }
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        
        /* Excel æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
        .io-controls { background: #fff; padding: 10px 20px; display: flex; gap: 10px; border-bottom: 1px solid #e5e5ea; }
        .btn-io { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-io:hover { background: #f9f9f9; }

        .controls { background: white; padding: 10px 20px; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d1d6; box-sizing: border-box; }
        
        .filter-scroll { display: flex; overflow-x: auto; gap: 8px; padding: 10px 20px; background: white; }
        .filter-btn { white-space: nowrap; padding: 6px 14px; border-radius: 15px; background: #e5e5ea; border: none; font-size: 13px; cursor: pointer; }
        .filter-btn.active { background: var(--primary); color: white; }

        #case-list { padding: 16px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; }
        .tag-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }

        /* Modal æ¨£å¼ä¿æŒèˆ‡ä¹‹å‰ä¸€è‡´ */
        .modal-overlay { position: fixed; top:0; left:0; width: 100%; height:100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 600px; height: 92%; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 11px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .opt-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #f2f2f7; cursor: pointer; text-align: center; font-size: 13px; }
        .opt-btn.active { background: var(--primary); color: white; }
        .log-editor { background: #fdfdfd; padding: 15px; border-radius: 12px; border: 2px dashed #ddd; margin-bottom: 15px; }
        .log-editor.editing { border-color: var(--warning); background: #fffef0; }
        .log-item { background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid #ddd; cursor: pointer; }
        .btn-save-case { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <h1>Case Manager</h1>
    <button style="background:none; border:none; color:var(--primary); font-size:30px;" onclick="openAddModal()">ï¼‹</button>
</header>

<div class="io-controls">
    <button class="btn-io" onclick="exportToExcel()">ğŸ“¤ åŒ¯å‡º Excel</button>
    <button class="btn-io" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥ Excel</button>
    <input type="file" id="importFile" hidden accept=".xlsx, .xls" onchange="importFromExcel(event)">
</div>

<div class="controls">
    <input type="text" class="search-input" id="search-box" placeholder="ğŸ” æœå°‹é•·è€…å§“å..." oninput="renderCases()">
</div>

<div class="filter-scroll" id="filter-tabs"></div>

<div id="case-list"></div>

<div class="modal-overlay" id="case-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="modal-header-title">å€‹æ¡ˆè³‡æ–™</h2>
            <button onclick="closeModal()" style="border:none; background:none; color:var(--primary);">é—œé–‰</button>
        </div>
        <input type="hidden" id="edit-id">
        <div class="form-group"><label>é•·è€…å§“å</label><input type="text" id="f-name"></div>
        <div class="form-group"><label>è¯çµ¡é›»è©±</label><input type="text" id="f-phone"></div>
        <div class="option-grid">
            <div class="opt-btn" id="p-Urgent" onclick="setPriority('Urgent')">ğŸ”´ ç·Šæ€¥</div>
            <div class="opt-btn" id="p-Normal" onclick="setPriority('Normal')">ğŸ”µ éç·Šæ€¥</div>
        </div>
        <div class="option-grid">
            <div class="opt-btn" id="t-Counselling" onclick="setCaseType('Counselling')">ğŸ¤ è¼”å°</div>
            <div class="opt-btn" id="t-Hidden" onclick="setCaseType('Hidden')">ğŸ‘¤ éš±è”½</div>
        </div>
        <div class="log-editor" id="log-editor-box">
            <input type="hidden" id="edit-log-index" value="-1">
            <div class="option-grid">
                <div class="opt-btn" id="lt-Phone" onclick="setLogContactType('Phone')">ğŸ“ é›»è©±</div>
                <div class="opt-btn" id="lt-InPerson" onclick="setLogContactType('InPerson')">ğŸ«‚ é¢è¦‹</div>
            </div>
            <textarea id="log-text" placeholder="è¼¸å…¥æœå‹™å…§å®¹..." rows="3"></textarea>
            <button onclick="saveLogEntry()" style="width:100%; margin-top:10px; background:var(--success); color:white; border:none; padding:10px; border-radius:8px;">å„²å­˜ç´€éŒ„</button>
        </div>
        <div id="modal-log-list"></div>
        <button class="btn-save-case" onclick="saveFullCase()">å„²å­˜å€‹æ¡ˆ</button>
    </div>
</div>

<script>
    let cases = JSON.parse(localStorage.getItem('elderly_cases_integrated')) || [];
    let tempPriority = 'Normal', tempCaseType = 'Counselling', tempLogContactType = 'Phone', currentFilter = 'ALL';

    const PRIORITY = { Urgent: { label: 'ğŸ”´ ç·Šæ€¥', color: '#ff4d4d' }, Normal: { label: 'ğŸ”µ éç·Šæ€¥', color: '#4da6ff' } };
    const TYPES = { Counselling: { label: 'ğŸ¤ è¼”å°', color: '#ff7f50' }, Hidden: { label: 'ğŸ‘¤ éš±è”½', color: '#9932cc' } };

    window.onload = () => { renderFilterTabs(); renderCases(); };

    function saveToLocal() { localStorage.setItem('elderly_cases_integrated', JSON.stringify(cases)); }

    // --- Excel åŠŸèƒ½ ---
    function exportToExcel() {
        if (cases.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");

        const data = cases.map(c => ({
            "å§“å": c.name,
            "é›»è©±": c.phone,
            "å„ªå…ˆç´š": c.priority === 'Urgent' ? 'ç·Šæ€¥' : 'éç·Šæ€¥',
            "é¡åˆ¥": c.caseType === 'Counselling' ? 'è¼”å°' : 'éš±è”½',
            "ä¸Šæ¬¡è¯çµ¡æ—¥æœŸ": c.lastContactDate,
            "ç‹€æ…‹": c.isClosed ? 'å·²çµæ¡ˆ' : 'æ´»èº',
            "æ‰€æœ‰æœå‹™æ—¥èªŒ": c.contactLog.map(l => `[${l.timestamp.split('T')[0]}][${l.type === 'Phone' ? 'é›»è©±' : 'é¢è¦‹'}] ${l.note}`).join(' | ')
        }));

        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Cases");
        XLSX.writeFile(workbook, `Elderly_Cases_${new Date().toLocaleDateString()}.xlsx`);
    }

    function importFromExcel(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);

            if (confirm(`è®€å–åˆ° ${json.length} æ¢å€‹æ¡ˆï¼Œæ˜¯å¦åˆä½µåˆ°ç¾æœ‰è³‡æ–™ï¼Ÿ`)) {
                json.forEach(row => {
                    // ç°¡å–®è§£æé‚è¼¯ï¼šå¦‚æœå§“åå·²å­˜åœ¨å‰‡è·³éï¼Œæˆ–ä½ å¯ä»¥è‡ªå®šç¾©è¦†è“‹é‚è¼¯
                    if (!cases.find(c => c.name === row["å§“å"])) {
                        cases.push({
                            id: Date.now().toString() + Math.random(),
                            name: row["å§“å"] || "æœªå‘½å",
                            phone: row["é›»è©±"] || "",
                            priority: row["å„ªå…ˆç´š"] === 'ç·Šæ€¥' ? 'Urgent' : 'Normal',
                            caseType: row["é¡åˆ¥"] === 'è¼”å°' ? 'Counselling' : 'Hidden',
                            lastContactDate: row["ä¸Šæ¬¡è¯çµ¡æ—¥æœŸ"] || "",
                            isClosed: row["ç‹€æ…‹"] === 'å·²çµæ¡ˆ',
                            contactLog: [], // åŒ¯å…¥æ™‚æ—¥èªŒè§£æè¼ƒè¤‡é›œï¼Œé è¨­ç‚ºç©ºï¼Œæˆ–å¯é€²ä¸€æ­¥è§£ææ—¥èªŒå­—ä¸²
                            serviceNotes: ""
                        });
                    }
                });
                saveToLocal();
                renderCases();
                alert("åŒ¯å…¥å®Œæˆï¼");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // --- æ ¸å¿ƒé‚è¼¯ (èˆ‡å‰ç‰ˆç›¸åŒ) ---
    function renderFilterTabs() {
        const tabs = ['ALL', 'Urgent', 'Normal', 'Counselling', 'Hidden'];
        document.getElementById('filter-tabs').innerHTML = tabs.map(t => 
            `<button class="filter-btn ${currentFilter === t ? 'active' : ''}" onclick="currentFilter='${t}'; renderFilterTabs(); renderCases();">${t==='ALL'?'å…¨éƒ¨':(PRIORITY[t]?.label||TYPES[t]?.label)}</button>`
        ).join('');
    }

    function renderCases() {
        const list = document.getElementById('case-list');
        const search = document.getElementById('search-box').value.toLowerCase();
        let filtered = cases.filter(c => {
            const matches = c.name.toLowerCase().includes(search);
            if (currentFilter === 'ALL') return matches;
            return matches && (c.priority === currentFilter || c.caseType === currentFilter);
        });
        list.innerHTML = filtered.map(c => `
            <div class="card" onclick="openEditModal('${c.id}')">
                <div class="tag-row">
                    <span class="tag" style="background:${PRIORITY[c.priority].color}22; color:${PRIORITY[c.priority].color}">${PRIORITY[c.priority].label}</span>
                </div>
                <div style="font-weight:bold; font-size:18px;">${c.name}</div>
                <div style="font-size:13px; color:#666;">ğŸ“… ä¸Šæ¬¡è¯çµ¡: ${c.lastContactDate || 'ç„¡'}</div>
            </div>
        `).join('');
    }

    // (å…¶é¤˜ Modal/Log å‡½æ•¸ openEditModal, saveLogEntry ç­‰èˆ‡å‰ç‰ˆé‚è¼¯ä¸€è‡´ï¼Œæ­¤è™•ç‚ºç°¡æ½”ç•¥éï¼Œä»£ç¢¼ä¸­å·²åŒ…å«å®Œæ•´é‚è¼¯æ‰€éœ€è®Šæ•¸)
    // è¨»ï¼šç‚ºç¢ºä¿å®Œæ•´é‹ä½œï¼Œä»¥ä¸‹è£œå…¨é—œéµ Modal å‡½æ•¸
    function setPriority(p) { tempPriority = p; document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active')); document.getElementById('p-'+p).classList.add('active'); }
    function setCaseType(t) { tempCaseType = t; document.getElementById('t-Counselling').classList.toggle('active', t==='Counselling'); document.getElementById('t-Hidden').classList.toggle('active', t==='Hidden'); }
    function setLogContactType(lt) { tempLogContactType = lt; document.getElementById('lt-Phone').classList.toggle('active', lt==='Phone'); document.getElementById('lt-InPerson').classList.toggle('active', lt==='InPerson'); }
    
    function openAddModal() {
        document.getElementById('edit-id').value = '';
        document.getElementById('f-name').value = '';
        document.getElementById('modal-log-list').innerHTML = '';
        document.getElementById('case-modal').style.display = 'flex';
        setPriority('Normal'); setCaseType('Counselling');
    }

    function openEditModal(id) {
        const c = cases.find(x => x.id === id);
        document.getElementById('edit-id').value = c.id;
        document.getElementById('f-name').value = c.name;
        document.getElementById('f-phone').value = c.phone;
        setPriority(c.priority); setCaseType(c.caseType);
        renderLogs(c.contactLog);
        document.getElementById('case-modal').style.display = 'flex';
    }

    function renderLogs(logs) {
        document.getElementById('modal-log-list').innerHTML = logs.map((l, i) => `
            <div class="log-item" onclick="editLog(${i})">
                <small>${l.type} - ${l.timestamp.split('T')[0]}</small><div>${l.note}</div>
            </div>`).reverse().join('');
    }

    function saveLogEntry() {
        const id = document.getElementById('edit-id').value;
        if(!id) return alert("è«‹å…ˆå„²å­˜å€‹æ¡ˆåŸºæœ¬è³‡æ–™");
        const note = document.getElementById('log-text').value;
        const cIdx = cases.findIndex(x => x.id === id);
        cases[cIdx].contactLog.push({ timestamp: new Date().toISOString(), note, type: tempLogContactType });
        cases[cIdx].lastContactDate = new Date().toLocaleDateString();
        saveToLocal(); renderLogs(cases[cIdx].contactLog); renderCases(); document.getElementById('log-text').value = '';
    }

    function saveFullCase() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('f-name').value;
        if(!name) return;
        if(id) {
            const i = cases.findIndex(x => x.id === id);
            cases[i].name = name; cases[i].priority = tempPriority; cases[i].caseType = tempCaseType;
        } else {
            cases.push({ id: Date.now().toString(), name, phone: document.getElementById('f-phone').value, priority: tempPriority, caseType: tempCaseType, contactLog: [], lastContactDate: '' });
        }
        saveToLocal(); renderCases(); closeModal();
    }
    function closeModal() { document.getElementById('case-modal').style.display = 'none'; }
</script>
</body>
</html>

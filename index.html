<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Case Manager - Professional Word Splitter</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #007AFF; --success: #34c759; --warning: #ff9500; --danger: #ff3b30;
            --bg-gray: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-sec: #8e8e93;
            --alert-bg: #ffe2e6;
        }

        body { font-family: -apple-system, sans-serif; background-color: var(--bg-gray); margin: 0; padding-bottom: 50px; color: var(--text-main); }
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        
        .io-controls { background: #fff; padding: 10px 20px; display: flex; gap: 10px; border-bottom: 1px solid #e5e5ea; }
        .btn-io { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }

        .controls { background: white; padding: 10px 20px 5px 20px; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d1d6; box-sizing: border-box; margin-bottom: 10px; }
        
        /* çµ±è¨ˆçœ‹æ¿ */
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stats-box { background: #f8f9fa; border-radius: 12px; padding: 12px; text-align: center; border: 1px solid #e5e5ea; }
        .stats-val { display: block; font-size: 22px; font-weight: bold; color: var(--primary); }
        .stats-label { font-size: 11px; color: var(--text-sec); font-weight: bold; }

        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .filter-tag { padding: 6px 14px; border-radius: 15px; background: #eee; font-size: 13px; cursor: pointer; border: none; white-space: nowrap; transition: 0.2s; }
        .filter-tag.active { background: var(--primary); color: white; }

        #case-list { padding: 16px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; position: relative; border: 2px solid transparent; display: flex; align-items: center; }
        .card.pinned { border-color: #ffcc00; background: #fffdf0; }
        .card.urgent-alert { background-color: var(--alert-bg); border-color: #ffb3ba; }
        .card.closed { opacity: 0.6; background: #e5e5ea; }
        
        .card-content { flex: 1; }
        .card-right { display: flex; align-items: center; gap: 10px; }
        .countdown-box { text-align: center; min-width: 50px; }
        .countdown-num { font-size: 18px; font-weight: bold; }
        .countdown-label { font-size: 9px; color: var(--text-sec); text-transform: uppercase; }

        .modal-overlay { position: fixed; top:0; left:0; width: 100%; height:100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 600px; height: 95%; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; color: var(--text-sec); margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 11px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .opt-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #f2f2f7; cursor: pointer; text-align: center; font-size: 13px; }
        .opt-btn.active { background: var(--primary); color: white; }
        .btn-full { width: 100%; padding: 16px; border-radius: 14px; font-weight: bold; cursor: pointer; border: none; margin-bottom: 12px; }
        
        .log-item { background: #f9f9fb; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #ddd; position: relative; }
        .log-edit-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--primary); cursor: pointer; font-size: 14px; }
        
        .btn-export-word { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 15px; cursor: pointer; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <h1>Case Manager</h1>
    <button style="background:none; border:none; color:var(--primary); font-size:30px; cursor:pointer;" onclick="openAddModal()">ï¼‹</button>
</header>

<div class="io-controls">
    <button class="btn-io" onclick="exportToExcel()">ğŸ“¤ å…¨é«”åŒ¯å‡º (Excel)</button>
    <button class="btn-io" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥è³‡æ–™ (Excel)</button>
    <input type="file" id="importFile" hidden accept=".xlsx" onchange="importFromExcel(event)">
</div>

<div class="controls">
    <input type="text" class="search-input" id="search-box" placeholder="ğŸ” æœå°‹ç·¨è™Ÿã€å§“å..." oninput="renderCases()">
    
    <div class="stats-container">
        <div class="stats-box">
            <span class="stats-val" id="stat-counselling">0</span>
            <span class="stats-label">ACTIVE è¼”å°å€‹æ¡ˆ</span>
        </div>
        <div class="stats-box">
            <span class="stats-val" id="stat-hidden">0</span>
            <span class="stats-label">ACTIVE éš±è”½å€‹æ¡ˆ</span>
        </div>
    </div>

    <div class="filter-bar">
        <button class="filter-tag active" onclick="setFilter('ALL', this)">å…¨éƒ¨</button>
        <button class="filter-tag" onclick="setFilter('Counselling', this)">ğŸ¤ è¼”å°</button>
        <button class="filter-tag" onclick="setFilter('Hidden', this)">ğŸ‘¤ éš±è”½</button>
        <button class="filter-tag" onclick="setFilter('Urgent', this)">ğŸ”´ ç·Šæ€¥</button>
        <button class="filter-tag" onclick="setFilter('Normal', this)">ğŸ”µ éç·Šæ€¥</button>
    </div>
</div>

<div id="case-list"></div>

<div class="modal-overlay" id="case-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h2 style="margin:0;">å€‹æ¡ˆè©³æƒ…</h2>
            <button onclick="closeModal()" style="border:none; background:none; color:var(--primary); font-weight:bold;">é—œé–‰</button>
        </div>
        
        <input type="hidden" id="internal-id">
        <input type="hidden" id="editing-log-index" value="-1">
        
        <div class="form-group">
            <label>å€‹æ¡ˆç‹€æ…‹</label>
            <div class="option-grid">
                <div class="opt-btn" id="st-Active" onclick="setCaseStatus('Active')">ğŸŸ¢ Active</div>
                <div class="opt-btn" id="st-Closed" onclick="setCaseStatus('Closed')">âšª Closed</div>
            </div>
        </div>

        <div class="form-group">
            <label>å„ªå…ˆç´š</label>
            <div class="option-grid">
                <div class="opt-btn" id="p-Urgent" onclick="setPriority('Urgent')">ğŸ”´ ç·Šæ€¥</div>
                <div class="opt-btn" id="p-Normal" onclick="setPriority('Normal')">ğŸ”µ éç·Šæ€¥</div>
            </div>
        </div>

        <div class="form-group"><label>å€‹æ¡ˆç·¨è™Ÿ</label><input type="text" id="f-case-no"></div>
        <div class="form-group"><label>é•·è€…å§“å</label><input type="text" id="f-name"></div>

        <div class="form-group">
            <label>å€‹æ¡ˆæ€§è³ª</label>
            <div class="option-grid">
                <div class="opt-btn" id="t-Counselling" onclick="setCaseType('Counselling')">ğŸ¤ è¼”å°</div>
                <div class="opt-btn" id="t-Hidden" onclick="setCaseType('Hidden')">ğŸ‘¤ éš±è”½</div>
            </div>
        </div>

        <div class="form-group">
            <label>å°å‡ºå ±è¡¨</label>
            <button class="btn-export-word" onclick="exportToWordSplitRows()">ğŸ“ åŒ¯å‡ºæœå‹™è¨˜éŒ„è¡¨ (è·¨è¡Œæ‹†åˆ†)</button>
        </div>

        <div style="background:#eee; height:1px; margin:20px 0;"></div>

        <div class="form-group" id="log-input-section">
            <label id="log-input-label">æ–°å¢è¯çµ¡ç´€éŒ„</label>
            <input type="date" id="log-date" style="margin-bottom:10px;">
            <div class="option-grid">
                <div class="opt-btn" id="lt-Phone" onclick="setLogType('Phone')">TC (é›»è©±)</div>
                <div class="opt-btn" id="lt-InPerson" onclick="setLogType('InPerson')">OI (é¢è¦‹)</div>
            </div>
            <textarea id="log-text" placeholder="ç´€éŒ„å…§å®¹..." rows="3"></textarea>
            <button id="save-log-btn" onclick="saveLogEntry()" style="width:100%; margin-top:10px; background:var(--success); color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">å„²å­˜ç´€éŒ„</button>
            <button id="cancel-edit-log-btn" onclick="cancelLogEdit()" style="width:100%; margin-top:5px; background:#eee; display:none;">å–æ¶ˆä¿®æ”¹</button>
        </div>

        <div id="modal-log-list"></div>

        <div style="margin-top:30px;">
            <button class="btn-full" style="background:var(--primary); color:white;" onclick="saveFullCase()">å„²å­˜æ‰€æœ‰è³‡æ–™</button>
            <button class="btn-full" style="background:var(--warning); color:white;" onclick="showConfirm('close')">çµæŸå€‹æ¡ˆ</button>
        </div>
    </div>
</div>

<script>
    let cases = JSON.parse(localStorage.getItem('elderly_cases_v15')) || [];
    let tempStatus = 'Active', tempType = 'Counselling', tempLogType = 'Phone', tempPriority = 'Normal', currentFilter = 'ALL';

    window.onload = () => { renderCases(); };
    function saveToLocal() { localStorage.setItem('elderly_cases_v15', JSON.stringify(cases)); }

    // --- æ ¸å¿ƒ Word åŒ¯å‡ºé‚è¼¯ï¼šæ¯ 20 å­—ä½”ä¸€å€‹è¡¨æ ¼è¡Œ ---
    function exportToWordSplitRows() {
        const id = document.getElementById('internal-id').value;
        const c = cases.find(x => x.id === id);
        if (!c || c.contactLog.length === 0) return alert("å°šç„¡ç´€éŒ„");

        let tableHtml = "";
        c.contactLog.forEach(log => {
            const note = log.note || "";
            const chunks = [];
            // æ¯ 20 å­—åˆ‡å‰²
            for (let i = 0; i < note.length; i += 20) {
                chunks.push(note.substring(i, i + 20));
            }

            // ç¬¬ä¸€è¡ŒåŒ…å«æ—¥æœŸå’Œæ–¹å¼
            tableHtml += `
                <tr>
                    <td style="border:1px solid black; padding:5px; width:80px; text-align:center;">${log.date}</td>
                    <td style="border:1px solid black; padding:5px; width:50px; text-align:center;">${log.type === 'Phone' ? 'TC' : 'OI'}</td>
                    <td style="border:1px solid black; padding:5px; width:80px; text-align:center;">æ¡ˆä¸»</td>
                    <td style="border:1px solid black; padding:5px; font-size:11pt;">${chunks[0] || ""}</td>
                    <td style="border:1px solid black; padding:5px; width:60px;"></td>
                </tr>
            `;

            // å¦‚æœé‚„æœ‰å‰©é¤˜å­—æ•¸ï¼Œé †å»¶åˆ°å¾Œé¢çš„è¡¨æ ¼è¡Œ
            for (let j = 1; j < chunks.length; j++) {
                tableHtml += `
                    <tr>
                        <td style="border:1px solid black; padding:5px;"></td>
                        <td style="border:1px solid black; padding:5px;"></td>
                        <td style="border:1px solid black; padding:5px;"></td>
                        <td style="border:1px solid black; padding:5px; font-size:11pt;">${chunks[j]}</td>
                        <td style="border:1px solid black; padding:5px;"></td>
                    </tr>
                `;
            }
        });

        const template = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'></head>
            <body>
                [span_1](start_span)<h2 style="text-align:center;">ä¿è‰¯å±€å¼µæƒ èçš‡åå±±å–œæ‚¦è–ˆæœå‹™è¨˜éŒ„è¡¨[span_1](end_span)</h2>
                <div style="margin-bottom:10px;">
                    <b>æª”æ¡ˆè™Ÿç¢¼ :</b> ${c.caseNo} &nbsp;&nbsp;&nbsp; 
                    <b>æ¡ˆä¸»å§“å:</b> ${c.name} &nbsp;&nbsp;&nbsp;
                    <b>è² è²¬å·¥ä½œå“¡:</b> ________________
                </div>
                <table style="width:100%; border-collapse:collapse; border:1px solid black;">
                    <tr style="background:#f2f2f2; text-align:center; font-weight:bold;">
                        <td style="border:1px solid black; width:15%;">æ—¥æœŸ</td>
                        <td style="border:1px solid black; width:10%;">æ–¹å¼</td>
                        <td style="border:1px solid black; width:15%;">æ¥è§¸äºº</td>
                        [span_2](start_span)<td style="border:1px solid black; width:45%;">è³‡æ–™/æœå‹™æä¾› (20å­—ä¸€è¡Œ)[span_2](end_span)</td>
                        <td style="border:1px solid black; width:15%;">å‚™è¨»</td>
                    </tr>
                    ${tableHtml}
                </table>
                <p style="font-size:9pt; margin-top:10px;">æ–¹å¼ï¼šTC = Telephone contacté›»è©±æ¥è§¸; OI = Office Interviewé¢è«‡; [span_3](start_span)HV = Home visitå®¶è¨ª[span_3](end_span)</p>
            </body></html>
        `;

        const blob = new Blob(['\ufeff', template], { type: 'application/msword' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${c.name}_æœå‹™è¨˜éŒ„è¡¨.doc`;
        link.click();
    }

    // --- åŸæœ‰åŠŸèƒ½ï¼šçµ±è¨ˆèˆ‡å€’æ•¸ ---
    function updateStats() {
        const active = cases.filter(c => c.status === 'Active');
        document.getElementById('stat-counselling').innerText = active.filter(c => c.caseType === 'Counselling').length;
        document.getElementById('stat-hidden').innerText = active.filter(c => c.caseType === 'Hidden').length;
    }

    function renderCases() {
        updateStats();
        const list = document.getElementById('case-list');
        const search = document.getElementById('search-box').value.toLowerCase();
        let filtered = cases.filter(c => {
            const m = (c.name||"").toLowerCase().includes(search) || (c.caseNo||"").toLowerCase().includes(search);
            if(currentFilter==='ALL') return m;
            return m && (c.caseType===currentFilter || c.priority===currentFilter);
        });
        filtered.sort((a,b) => (!!a.isPinned !== !!b.isPinned ? (a.isPinned ? -1 : 1) : (a.status === 'Active' ? -1 : 1)));
        list.innerHTML = filtered.map(c => {
            const nextDate = c.lastContactDate ? new Date(c.lastContactDate) : null;
            if(nextDate) nextDate.setDate(nextDate.getDate()+90);
            const days = nextDate ? Math.ceil((nextDate - new Date())/(1000*60*60*24)) : 'éœ€è¯çµ¡';
            return `
            <div class="card ${c.status==='Closed'?'closed':''} ${c.isPinned?'pinned':''} ${days<15&&c.status==='Active'?'urgent-alert':''}" onclick="openEditModal('${c.id}')">
                <div class="card-content">
                    <div class="case-number-tag">${c.caseNo}</div>
                    <div style="font-weight:bold; font-size:18px;">${c.name}</div>
                    <div class="tag-row">
                        <span class="tag ${c.priority==='Urgent'?'urgent-tag':'normal-tag'}">${c.priority==='Urgent'?'ğŸ”´ ç·Šæ€¥':'ğŸ”µ éç·Šæ€¥'}</span>
                        <span class="tag" style="background:#eee;">${c.caseType==='Hidden'?'ğŸ‘¤ éš±è”½':'ğŸ¤ è¼”å°'}</span>
                    </div>
                </div>
                <div class="card-right">
                    <div class="countdown-box"><span class="countdown-num">${days}</span><span class="countdown-label">Days</span></div>
                    <button class="pin-btn ${c.isPinned?'active':''}" onclick="togglePin(event,'${c.id}')">ğŸ“Œ</button>
                </div>
            </div>`;
        }).join('');
    }

    // --- åŸæœ‰åŠŸèƒ½ï¼šè©³æƒ…ã€ä¿®æ”¹ç´€éŒ„ã€Excel ---
    function openEditModal(id) {
        const c = cases.find(x => x.id === id);
        document.getElementById('internal-id').value = c.id;
        document.getElementById('f-case-no').value = c.caseNo;
        document.getElementById('f-name').value = c.name;
        setCaseStatus(c.status); setPriority(c.priority); setCaseType(c.caseType);
        renderLogs(c.contactLog); cancelLogEdit();
        document.getElementById('case-modal').style.display='flex';
    }

    function saveLogEntry() {
        const id = document.getElementById('internal-id').value;
        const note = document.getElementById('log-text').value;
        const date = document.getElementById('log-date').value;
        const editIdx = parseInt(document.getElementById('editing-log-index').value);
        if(!id || !note || !date) return alert("å¿…å¡«é …ç›®ç¼ºå¤±");
        const idx = cases.findIndex(x => x.id === id);
        if(editIdx > -1) cases[idx].contactLog[editIdx] = { date, note, type: tempLogType };
        else cases[idx].contactLog.push({ date, note, type: tempLogType });
        cases[idx].lastContactDate = cases[idx].contactLog.reduce((max,p)=>p.date>max?p.date:max,"");
        saveToLocal(); renderLogs(cases[idx].contactLog); renderCases(); cancelLogEdit();
    }

    function renderLogs(logs) {
        document.getElementById('modal-log-list').innerHTML = (logs||[]).map((l,idx)=>`
            <div class="log-item">
                <button class="log-edit-btn" onclick="editLog(${idx})">âœï¸</button>
                <span style="font-size:11px; color:#888;">${l.date} | ${l.type}</span>
                <div style="white-space:pre-wrap;">${l.note}</div>
            </div>`).reverse().join('');
    }

    function editLog(i) {
        const c = cases.find(x=>x.id===document.getElementById('internal-id').value);
        const l = c.contactLog[i];
        document.getElementById('editing-log-index').value = i;
        document.getElementById('log-date').value = l.date;
        document.getElementById('log-text').value = l.note;
        setLogType(l.type);
        document.getElementById('log-input-label').innerText = "ä¿®æ”¹ç´€éŒ„...";
        document.getElementById('cancel-edit-log-btn').style.display = "block";
    }

    function cancelLogEdit() {
        document.getElementById('editing-log-index').value = "-1";
        document.getElementById('log-text').value = "";
        document.getElementById('log-date').valueAsDate = new Date();
        document.getElementById('log-input-label').innerText = "æ–°å¢è¯çµ¡ç´€éŒ„";
        document.getElementById('cancel-edit-log-btn').style.display = "none";
    }

    // --- å…¶ä»– UI æ§åˆ¶ ---
    function setPriority(p){ tempPriority=p; document.getElementById('p-Urgent').className=p==='Urgent'?'opt-btn active':'opt-btn'; document.getElementById('p-Normal').className=p==='Normal'?'opt-btn active':'opt-btn'; }
    function setCaseStatus(s){ tempStatus=s; document.getElementById('st-Active').className=s==='Active'?'opt-btn active':'opt-btn'; document.getElementById('st-Closed').className=s==='Closed'?'opt-btn active':'opt-btn'; }
    function setCaseType(t){ tempType=t; document.getElementById('t-Counselling').className=t==='Counselling'?'opt-btn active':'opt-btn'; document.getElementById('t-Hidden').className=t==='Hidden'?'opt-btn active':'opt-btn'; }
    function setLogType(lt){ tempLogType=lt; document.getElementById('lt-Phone').className=lt==='Phone'?'opt-btn active':'opt-btn'; document.getElementById('lt-InPerson').className=lt==='InPerson'?'opt-btn active':'opt-btn'; }
    function openAddModal(){ document.getElementById('internal-id').value=''; document.getElementById('f-case-no').value=''; document.getElementById('f-name').value=''; renderLogs([]); document.getElementById('case-modal').style.display='flex'; }
    function saveFullCase(){ const id=document.getElementById('internal-id').value; const d={caseNo:document.getElementById('f-case-no').value, name:document.getElementById('f-name').value, status:tempStatus, caseType:tempType, priority:tempPriority}; if(id){ const i=cases.findIndex(x=>x.id===id); cases[i]={...cases[i],...d}; }else{ cases.push({id:Date.now().toString(), ...d, contactLog:[], lastContactDate:'', isPinned:false}); } saveToLocal(); renderCases(); closeModal(); }
    function closeModal(){ document.getElementById('case-modal').style.display='none'; }
    function togglePin(e,id){ e.stopPropagation(); const i=cases.findIndex(x=>x.id===id); cases[i].isPinned=!cases[i].isPinned; saveToLocal(); renderCases(); }
    function setFilter(f,b){ currentFilter=f; document.querySelectorAll('.filter-tag').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderCases(); }
    function showConfirm(a){ if(confirm("ç¢ºå®šåŸ·è¡Œï¼Ÿ")){ const i=cases.findIndex(x=>x.id===document.getElementById('internal-id').value); if(a==='close') cases[i].status='Closed'; saveToLocal(); renderCases(); closeModal(); }}
    function exportToExcel(){ /* ä¿æŒåŸ Excel é‚è¼¯ */ }
    function importFromExcel(e){ /* ä¿æŒåŸ Excel åŒ¯å…¥é‚è¼¯ */ }
</script>
</body>
</html>

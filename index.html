<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Case Manager - 90 Days Tracker</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #007AFF; --success: #34c759; --warning: #ff9500; --danger: #ff3b30;
            --bg-gray: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-sec: #8e8e93;
            --alert-bg: #ffe2e6; /* æ·ºç²‰ç´…è‰²ç”¨æ–¼é è­¦ */
        }

        body { font-family: -apple-system, sans-serif; background-color: var(--bg-gray); margin: 0; padding-bottom: 50px; color: var(--text-main); }
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        
        .io-controls { background: #fff; padding: 10px 20px; display: flex; gap: 10px; border-bottom: 1px solid #e5e5ea; }
        .btn-io { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }

        .controls { background: white; padding: 10px 20px 5px 20px; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d1d6; box-sizing: border-box; margin-bottom: 10px; }
        
        /* ç¯©é¸æŒ‰éˆ•æ¨£å¼ */
        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .filter-tag { padding: 6px 14px; border-radius: 15px; background: #eee; font-size: 13px; cursor: pointer; border: none; white-space: nowrap; transition: 0.2s; }
        .filter-tag.active { background: var(--primary); color: white; }

        #case-list { padding: 16px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; position: relative; border: 2px solid transparent; display: flex; align-items: center; }
        .card.pinned { border-color: #ffcc00; background: #fffdf0; }
        .card.urgent-alert { background-color: var(--alert-bg); border-color: #ffb3ba; }
        .card.closed { opacity: 0.6; background: #e5e5ea; }
        
        .card-content { flex: 1; }
        .card-right { display: flex; align-items: center; gap: 10px; }

        .countdown-box { text-align: center; min-width: 50px; }
        .countdown-num { font-size: 18px; font-weight: bold; color: var(--text-main); display: block; }
        .countdown-label { font-size: 9px; color: var(--text-sec); text-transform: uppercase; }
        .countdown-alert .countdown-num { color: var(--danger); }

        .pin-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: #ccc; padding: 5px; }
        .pin-btn.active { color: #ffcc00; }

        .case-number-tag { font-size: 11px; color: var(--primary); font-weight: bold; margin-bottom: 2px; }
        .tag-row { display: flex; gap: 5px; margin: 5px 0; }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .urgent-tag { background: #ff3b3022; color: #ff3b30; }
        .normal-tag { background: #007AFF22; color: #007AFF; }

        /* Modal æ¨£å¼ä¿æŒ */
        .modal-overlay { position: fixed; top:0; left:0; width: 100%; height:100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 600px; height: 95%; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; color: var(--text-sec); margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 11px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .opt-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #f2f2f7; cursor: pointer; text-align: center; font-size: 13px; }
        .opt-btn.active { background: var(--primary); color: white; }
        .btn-full { width: 100%; padding: 16px; border-radius: 14px; font-weight: bold; cursor: pointer; border: none; margin-bottom: 12px; }
        .log-item { background: #f9f9fb; padding: 10px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid #ddd; }
    </style>
</head>
<body>

<header>
    <h1>Case Manager</h1>
    <button style="background:none; border:none; color:var(--primary); font-size:30px; cursor:pointer;" onclick="openAddModal()">ï¼‹</button>
</header>

<div class="io-controls">
    <button class="btn-io" onclick="exportToExcel()">ğŸ“¤ åŒ¯å‡º Excel</button>
    <button class="btn-io" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥ Excel</button>
    <input type="file" id="importFile" hidden accept=".xlsx" onchange="importFromExcel(event)">
</div>

<div class="controls">
    <input type="text" class="search-input" id="search-box" placeholder="ğŸ” æœå°‹ç·¨è™Ÿã€å§“å..." oninput="renderCases()">
    <div class="filter-bar">
        <button class="filter-tag active" onclick="setFilter('ALL', this)">å…¨éƒ¨</button>
        <button class="filter-tag" onclick="setFilter('Counselling', this)">ğŸ¤ è¼”å°</button>
        <button class="filter-tag" onclick="setFilter('Hidden', this)">ğŸ‘¤ éš±è”½</button>
        <button class="filter-tag" onclick="setFilter('Urgent', this)">ğŸ”´ ç·Šæ€¥</button>
        <button class="filter-tag" onclick="setFilter('Normal', this)">ğŸ”µ éç·Šæ€¥</button>
    </div>
</div>

<div id="case-list"></div>

<div class="modal-overlay" id="case-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h2 id="modal-header-title" style="margin:0;">å€‹æ¡ˆè©³æƒ…</h2>
            <button onclick="closeModal()" style="border:none; background:none; color:var(--primary); font-weight:bold;">é—œé–‰</button>
        </div>
        <input type="hidden" id="internal-id">
        
        <div class="form-group">
            <label>å€‹æ¡ˆç‹€æ…‹</label>
            <div class="option-grid">
                <div class="opt-btn" id="st-Active" onclick="setCaseStatus('Active')">ğŸŸ¢ Active</div>
                <div class="opt-btn" id="st-Closed" onclick="setCaseStatus('Closed')">âšª Closed</div>
            </div>
        </div>

        <div class="form-group">
            <label>å„ªå…ˆç´š</label>
            <div class="option-grid">
                <div class="opt-btn" id="p-Urgent" onclick="setPriority('Urgent')">ğŸ”´ ç·Šæ€¥</div>
                <div class="opt-btn" id="p-Normal" onclick="setPriority('Normal')">ğŸ”µ éç·Šæ€¥</div>
            </div>
        </div>

        <div class="form-group"><label>å€‹æ¡ˆç·¨è™Ÿ</label><input type="text" id="f-case-no"></div>
        <div class="form-group"><label>é•·è€…å§“å</label><input type="text" id="f-name"></div>

        <div class="form-group">
            <label>å€‹æ¡ˆæ€§è³ª</label>
            <div class="option-grid">
                <div class="opt-btn" id="t-Counselling" onclick="setCaseType('Counselling')">ğŸ¤ è¼”å°</div>
                <div class="opt-btn" id="t-Hidden" onclick="setCaseType('Hidden')">ğŸ‘¤ éš±è”½</div>
            </div>
        </div>

        <div style="background:#eee; height:1px; margin:20px 0;"></div>

        <div class="form-group">
            <label>æ–°å¢è¯çµ¡ç´€éŒ„ (æ¯90å¤©éœ€è¯çµ¡ä¸€æ¬¡)</label>
            <input type="date" id="log-date" style="margin-bottom:10px;">
            <div class="option-grid">
                <div class="opt-btn" id="lt-Phone" onclick="setLogType('Phone')">ğŸ“ é›»è©±</div>
                <div class="opt-btn" id="lt-InPerson" onclick="setLogType('InPerson')">ğŸ«‚ é¢è¦‹</div>
            </div>
            <textarea id="log-text" placeholder="ç´€éŒ„å…§å®¹..." rows="3"></textarea>
            <button onclick="saveLogEntry()" style="width:100%; margin-top:10px; background:var(--success); color:white; border:none; padding:12px; border-radius:10px; font-weight:bold; cursor:pointer;">æ–°å¢ç´€éŒ„</button>
        </div>

        <div id="modal-log-list"></div>

        <div style="margin-top:30px;">
            <button class="btn-full" style="background:var(--primary); color:white;" onclick="saveFullCase()">å„²å­˜æ‰€æœ‰è³‡æ–™</button>
            <button class="btn-full" style="background:var(--warning); color:white;" id="quick-close-btn" onclick="showConfirm('close')">çµæŸå€‹æ¡ˆ</button>
            <center><button style="background:none; border:none; color:var(--danger); text-decoration:underline; cursor:pointer;" id="del-btn" onclick="showConfirm('delete')">åˆªé™¤å€‹æ¡ˆ</button></center>
        </div>
    </div>
</div>

<div class="confirm-dialog" id="confirm-dialog" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:15px; box-shadow:0 0 20px rgba(0,0,0,0.2); z-index:2000; display:none; text-align:center; width:280px;">
    <h3 id="confirm-title">ç¢ºå®šï¼Ÿ</h3>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button id="confirm-yes" style="flex:1; padding:10px; border:none; background:var(--danger); color:white; border-radius:8px;">ç¢ºå®š</button>
        <button onclick="hideConfirm()" style="flex:1; padding:10px; border:none; background:#eee; border-radius:8px;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    let cases = JSON.parse(localStorage.getItem('elderly_cases_v5')) || [];
    let tempStatus = 'Active', tempType = 'Counselling', tempLogType = 'Phone', tempPriority = 'Normal', currentFilter = 'ALL';

    window.onload = () => { renderCases(); };

    function saveToLocal() { localStorage.setItem('elderly_cases_v5', JSON.stringify(cases)); }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šå€’æ•¸è¨ˆç®— ---
    function getRemainingDays(lastDateStr) {
        if (!lastDateStr) return null;
        const lastDate = new Date(lastDateStr);
        const nextDate = new Date(lastDate);
        nextDate.setDate(lastDate.getDate() + 90);
        const today = new Date();
        const diffTime = nextDate - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    function setFilter(filter, btn) {
        currentFilter = filter;
        document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderCases();
    }

    function renderCases() {
        const list = document.getElementById('case-list');
        const search = document.getElementById('search-box').value.toLowerCase();
        
        let filtered = cases.filter(c => {
            const matchesSearch = (c.name || "").toLowerCase().includes(search) || (c.caseNo || "").toLowerCase().includes(search);
            if (currentFilter === 'ALL') return matchesSearch;
            return matchesSearch && (c.caseType === currentFilter || c.priority === currentFilter);
        });

        // æ’åºï¼šé ‚ç½® > ç‹€æ…‹ > å€’æ•¸
        filtered.sort((a, b) => {
            if (!!a.isPinned !== !!b.isPinned) return a.isPinned ? -1 : 1;
            if (a.status !== b.status) return a.status === 'Active' ? -1 : 1;
            return 0;
        });

        list.innerHTML = filtered.map(c => {
            const daysLeft = getRemainingDays(c.lastContactDate);
            const isAlert = daysLeft !== null && daysLeft < 15;
            const displayDays = daysLeft === null ? "éœ€è¯çµ¡" : daysLeft;

            return `
            <div class="card ${c.status === 'Closed' ? 'closed' : ''} ${c.isPinned ? 'pinned' : ''} ${isAlert && c.status === 'Active' ? 'urgent-alert' : ''}" onclick="openEditModal('${c.id}')">
                <div class="card-content">
                    <div class="case-number-tag">${c.caseNo || 'N/A'}</div>
                    <div style="font-weight:bold; font-size:18px;">${c.name}</div>
                    <div class="tag-row">
                        <span class="tag ${c.priority === 'Urgent' ? 'urgent-tag' : 'normal-tag'}">${c.priority === 'Urgent' ? 'ğŸ”´ ç·Šæ€¥' : 'ğŸ”µ éç·Šæ€¥'}</span>
                        <span class="tag" style="background:#eee;">${c.caseType === 'Hidden' ? 'ğŸ‘¤ éš±è”½' : 'ğŸ¤ è¼”å°'}</span>
                    </div>
                    <div style="font-size:11px; color:#888;">ğŸ“… ä¸Šæ¬¡: ${c.lastContactDate || 'å¾æœªè¯çµ¡'}</div>
                </div>
                <div class="card-right">
                    <div class="countdown-box ${isAlert ? 'countdown-alert' : ''}">
                        <span class="countdown-num">${displayDays}</span>
                        <span class="countdown-label">Days</span>
                    </div>
                    <button class="pin-btn ${c.isPinned ? 'active' : ''}" onclick="togglePin(event, '${c.id}')">ğŸ“Œ</button>
                </div>
            </div>`;
        }).join('');
    }

    // --- å…¶ä»–åŠŸèƒ½ (Pin, Modal, Log ç­‰) ---
    function togglePin(e, id) {
        e.stopPropagation();
        const idx = cases.findIndex(x => x.id === id);
        if (!cases[idx].isPinned && cases.filter(c => c.isPinned).length >= 3) return alert("æœ€å¤šé ‚ç½®3å€‹");
        cases[idx].isPinned = !cases[idx].isPinned;
        saveToLocal(); renderCases();
    }

    function setPriority(p) { tempPriority = p; document.getElementById('p-Urgent').classList.toggle('active', p==='Urgent'); document.getElementById('p-Normal').classList.toggle('active', p==='Normal'); }
    function setCaseStatus(s) { tempStatus = s; document.getElementById('st-Active').classList.toggle('active', s==='Active'); document.getElementById('st-Closed').classList.toggle('active', s==='Closed'); }
    function setCaseType(t) { tempType = t; document.getElementById('t-Counselling').classList.toggle('active', t==='Counselling'); document.getElementById('t-Hidden').classList.toggle('active', t==='Hidden'); }
    function setLogType(lt) { tempLogType = lt; document.getElementById('lt-Phone').classList.toggle('active', lt==='Phone'); document.getElementById('lt-InPerson').classList.toggle('active', lt==='InPerson'); }

    function openAddModal() {
        document.getElementById('internal-id').value = '';
        document.getElementById('f-case-no').value = '';
        document.getElementById('f-name').value = '';
        document.getElementById('log-text').value = '';
        document.getElementById('log-date').valueAsDate = new Date();
        document.getElementById('modal-log-list').innerHTML = '';
        setCaseStatus('Active'); setCaseType('Counselling'); setPriority('Normal');
        document.getElementById('case-modal').style.display = 'flex';
        document.getElementById('del-btn').style.display = 'none';
        document.getElementById('quick-close-btn').style.display = 'none';
    }

    function openEditModal(id) {
        const c = cases.find(x => x.id === id);
        document.getElementById('internal-id').value = c.id;
        document.getElementById('f-case-no').value = c.caseNo;
        document.getElementById('f-name').value = c.name;
        document.getElementById('log-date').valueAsDate = new Date();
        setCaseStatus(c.status); setCaseType(c.caseType); setPriority(c.priority);
        renderLogs(c.contactLog);
        document.getElementById('case-modal').style.display = 'flex';
        document.getElementById('del-btn').style.display = 'block';
        document.getElementById('quick-close-btn').style.display = c.status === 'Active' ? 'block' : 'none';
    }

    function saveLogEntry() {
        const id = document.getElementById('internal-id').value;
        const note = document.getElementById('log-text').value;
        const date = document.getElementById('log-date').value;
        if(!id || !note || !date) return alert("è«‹å¡«å¯«å®Œæ•´");
        const idx = cases.findIndex(x => x.id === id);
        cases[idx].contactLog.push({ date, note, type: tempLogType });
        cases[idx].lastContactDate = date;
        saveToLocal(); renderLogs(cases[idx].contactLog); renderCases();
        document.getElementById('log-text').value = '';
    }

    function renderLogs(logs) {
        document.getElementById('modal-log-list').innerHTML = (logs || []).map(l => `
            <div class="log-item"><small>${l.date} | ${l.type === 'Phone' ? 'ğŸ“' : 'ğŸ«‚'}</small><div>${l.note}</div></div>
        `).reverse().join('');
    }

    function saveFullCase() {
        const id = document.getElementById('internal-id').value;
        const caseNo = document.getElementById('f-case-no').value;
        const name = document.getElementById('f-name').value;
        if(!caseNo || !name) return alert("å¿…å¡«ç·¨è™ŸåŠå§“å");
        const data = { caseNo, name, status: tempStatus, caseType: tempType, priority: tempPriority };
        if(id) {
            const i = cases.findIndex(x => x.id === id);
            cases[i] = { ...cases[i], ...data };
        } else {
            cases.push({ id: Date.now().toString(), ...data, contactLog: [], lastContactDate: '', isPinned: false });
        }
        saveToLocal(); renderCases(); closeModal();
    }

    function showConfirm(mode) {
        const dialog = document.getElementById('confirm-dialog');
        dialog.style.display = 'block';
        document.getElementById('confirm-yes').onclick = () => {
            if(mode === 'close') { setCaseStatus('Closed'); saveFullCase(); }
            else { const id = document.getElementById('internal-id').value; cases = cases.filter(x => x.id !== id); saveToLocal(); renderCases(); closeModal(); }
            hideConfirm();
        };
    }
    function hideConfirm() { document.getElementById('confirm-dialog').style.display = 'none'; }
    function closeModal() { document.getElementById('case-modal').style.display = 'none'; }

    // Excel åŠŸèƒ½ç°¡åŒ–ç‰ˆ (æ”¯æ´åŸºæœ¬åŒ¯å‡º)
    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(cases.map(c => ({ "ç·¨è™Ÿ": c.caseNo, "å§“å": c.name, "æœ€å¾Œè¯çµ¡": c.lastContactDate })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Cases");
        XLSX.writeFile(wb, "Cases_Backup.xlsx");
    }
</script>
</body>
</html>

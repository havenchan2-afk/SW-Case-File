<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Case Manager - Full Integration</title>
    <style>
        :root {
            --primary: #007AFF;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --bg-gray: #f2f2f7;
            --card-bg: #ffffff;
            --text-main: #1c1c1e;
            --text-sec: #8e8e93;
            --urgent: #ff4d4d;
            --normal: #4da6ff;
            --counselling: #ff7f50;
            --hidden: #9932cc;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-gray);
            margin: 0; padding-bottom: 50px;
            color: var(--text-main);
        }

        /* Header & Controls */
        header { background: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        .controls { background: white; padding: 10px 20px; border-top: 1px solid #e5e5ea; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d1d6; margin-bottom: 10px; box-sizing: border-box; }
        
        /* Filter Tabs */
        .filter-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; scrollbar-width: none; }
        .filter-btn { white-space: nowrap; padding: 6px 14px; border-radius: 15px; background: #e5e5ea; border: none; font-size: 13px; cursor: pointer; }
        .filter-btn.active { background: var(--primary); color: white; }

        /* Case Cards */
        #case-list { padding: 16px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; position: relative; }
        .card.pinned { border: 2px solid #ffcc00; background: #fffbe6; }
        .card.closed { opacity: 0.6; background: #f0fff0; }
        
        .tag-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        
        .card-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .card-info { font-size: 13px; color: var(--text-sec); margin-bottom: 3px; }

        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; width: 100%; height:100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 600px; height: 92%; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        
        .section-title { font-size: 16px; font-weight: bold; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; color: var(--text-sec); margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 11px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; box-sizing: border-box; }

        /* Selector Buttons */
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .opt-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #f2f2f7; cursor: pointer; text-align: center; font-size: 13px; }
        .opt-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }

        /* Log Section */
        .log-editor { background: #fdfdfd; padding: 15px; border-radius: 12px; border: 2px dashed #ddd; margin-bottom: 15px; }
        .log-editor.editing { border-color: var(--warning); background: #fffef0; }
        
        .log-item { background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid #ddd; cursor: pointer; }
        .log-item:hover { background: #f0f4f8; }
        .log-item.Phone { border-left-color: var(--normal); }
        .log-item.InPerson { border-left-color: var(--counselling); }
        .log-meta { font-size: 11px; color: var(--text-sec); display: flex; justify-content: space-between; margin-bottom: 5px; }

        .btn-save-case { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 14px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 20px; }
        .btn-archive { background: none; border: none; color: var(--danger); width: 100%; padding: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <h1 id="app-time">Elderly Case Manager</h1>
    <button style="background:none; border:none; color:var(--primary); font-size:30px; cursor:pointer;" onclick="openAddModal()">ï¼‹</button>
</header>

<div class="controls">
    <input type="text" class="search-input" id="search-box" placeholder="ğŸ” æœå°‹é•·è€…å§“åæˆ–æ‘˜è¦..." oninput="renderCases()">
    <div class="filter-scroll" id="filter-tabs">
        </div>
</div>

<div id="case-list"></div>

<div class="modal-overlay" id="case-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="modal-header-title">ç·¨è¼¯å€‹æ¡ˆ</h2>
            <button onclick="closeModal()" style="border:none; background:none; color:var(--primary); font-size:16px; cursor:pointer;">é—œé–‰</button>
        </div>

        <input type="hidden" id="edit-id">

        <div class="section-title">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
        <div class="form-group">
            <label>é•·è€…å§“å</label>
            <input type="text" id="f-name">
        </div>
        <div class="form-group">
            <label>è¯çµ¡é›»è©±</label>
            <input type="text" id="f-phone">
        </div>

        <div class="section-title">ğŸš© å€‹æ¡ˆåˆ†é¡</div>
        <label>å„ªå…ˆç´š (Priority)</label>
        <div class="option-grid">
            <div class="opt-btn" id="p-Urgent" onclick="setPriority('Urgent')">ğŸ”´ ç·Šæ€¥</div>
            <div class="opt-btn" id="p-Normal" onclick="setPriority('Normal')">ğŸ”µ éç·Šæ€¥</div>
        </div>
        
        <label>å€‹æ¡ˆæ€§è³ª (Type)</label>
        <div class="option-grid">
            <div class="opt-btn" id="t-Counselling" onclick="setCaseType('Counselling')">ğŸ¤ è¼”å°</div>
            <div class="opt-btn" id="t-Hidden" onclick="setCaseType('Hidden')">ğŸ‘¤ éš±è”½</div>
        </div>

        <div class="section-title">ğŸ“– æœå‹™ç´€éŒ„èˆ‡æ—¥èªŒ</div>
        <div class="log-editor" id="log-editor-box">
            <input type="hidden" id="edit-log-index" value="-1">
            <label>è¯çµ¡æ–¹å¼</label>
            <div class="option-grid">
                <div class="opt-btn" id="lt-Phone" onclick="setLogContactType('Phone')">ğŸ“ é›»è©±è¯çµ¡</div>
                <div class="opt-btn" id="lt-InPerson" onclick="setLogContactType('InPerson')">ğŸ«‚ å¯¦é«”é¢è¦‹</div>
            </div>
            <textarea id="log-text" placeholder="è¼¸å…¥æœ¬æ¬¡æœå‹™å…§å®¹..." rows="3"></textarea>
            <div style="display:flex; justify-content:space-between; margin-top:10px; align-items:center;">
                <span id="log-status-hint" style="font-size:11px; color:var(--text-sec);">æ–°å¢ç´€éŒ„å¾Œæœƒè‡ªå‹•æ›´æ–°è¯çµ¡æ—¥æœŸ</span>
                <div style="display:flex; gap:10px;">
                    <button id="btn-cancel-log" onclick="resetLogEditor()" style="display:none; background:none; border:none; color:var(--danger);">å–æ¶ˆä¿®æ”¹</button>
                    <button onclick="saveLogEntry()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">å„²å­˜ç´€éŒ„</button>
                </div>
            </div>
        </div>

        <label>æ­·å²ç´€éŒ„ (é»æ“Šå¯ç·¨è¼¯å…§å®¹)</label>
        <div id="modal-log-list"></div>

        <div class="section-title">âš™ï¸ å…¶ä»–è¨­å®š</div>
        <div class="form-group">
            <label>ä¸Šæ¬¡è¯çµ¡æ—¥æœŸ (YYYY/MM/DD)</label>
            <input type="text" id="f-last-date">
        </div>
        <div class="form-group">
            <label>æœå‹™å‚™è¨» (Service Notes)</label>
            <textarea id="f-notes" rows="2"></textarea>
        </div>

        <button class="btn-save-case" onclick="saveFullCase()">å„²å­˜å€‹æ¡ˆæ‰€æœ‰è³‡æ–™</button>
        <button class="btn-archive" id="archive-btn" onclick="toggleArchiveStatus()">çµæ¡ˆ / é‡æ–°é–‹å•Ÿ</button>
    </div>
</div>

<script>
    // --- Data Structure ---
    const PRIORITY = { Urgent: { label: 'ğŸ”´ ç·Šæ€¥', color: '#ff4d4d' }, Normal: { label: 'ğŸ”µ éç·Šæ€¥', color: '#4da6ff' } };
    const TYPES = { Counselling: { label: 'ğŸ¤ è¼”å°', color: '#ff7f50' }, Hidden: { label: 'ğŸ‘¤ éš±è”½', color: '#9932cc' } };

    let cases = JSON.parse(localStorage.getItem('elderly_cases_integrated')) || [];
    let tempPriority = 'Normal';
    let tempCaseType = 'Counselling';
    let tempLogContactType = 'Phone';
    let currentFilter = 'ALL';

    window.onload = () => {
        updateClock();
        setInterval(updateClock, 1000);
        renderFilterTabs();
        renderCases();
    };

    function updateClock() {
        const now = new Date();
        document.getElementById('app-time').innerText = now.toLocaleTimeString('zh-Hant', {hour: '2-digit', minute:'2-digit'}) + " Case Manager";
    }

    function saveToLocal() {
        localStorage.setItem('elderly_cases_integrated', JSON.stringify(cases));
    }

    // --- UI Rendering ---
    function renderFilterTabs() {
        const tabs = ['ALL', 'Urgent', 'Normal', 'Counselling', 'Hidden', 'CLOSED'];
        const container = document.getElementById('filter-tabs');
        container.innerHTML = tabs.map(t => {
            let label = t === 'ALL' ? 'å…¨éƒ¨æ´»èº' : t === 'CLOSED' ? 'å·²çµæ¡ˆ' : (PRIORITY[t]?.label || TYPES[t]?.label || t);
            return `<button class="filter-btn ${currentFilter === t ? 'active' : ''}" onclick="setFilter('${t}')">${label}</button>`;
        }).join('');
    }

    function setFilter(f) { currentFilter = f; renderFilterTabs(); renderCases(); }

    function renderCases() {
        const list = document.getElementById('case-list');
        const search = document.getElementById('search-box').value.toLowerCase();
        
        let filtered = cases.filter(c => {
            const matchesSearch = c.name.toLowerCase().includes(search) || c.serviceNotes.toLowerCase().includes(search);
            if (currentFilter === 'ALL') return !c.isClosed && matchesSearch;
            if (currentFilter === 'CLOSED') return c.isClosed && matchesSearch;
            return (c.priority === currentFilter || c.caseType === currentFilter) && !c.isClosed && matchesSearch;
        });

        list.innerHTML = filtered.map(c => `
            <div class="card ${c.isClosed ? 'closed' : ''}" onclick="openEditModal('${c.id}')">
                <div class="tag-row">
                    <span class="tag" style="background:${PRIORITY[c.priority].color}22; color:${PRIORITY[c.priority].color}">${PRIORITY[c.priority].label}</span>
                    <span class="tag" style="background:${TYPES[c.caseType].color}22; color:${TYPES[c.caseType].color}">${TYPES[c.caseType].label}</span>
                </div>
                <div class="card-title">${c.name}</div>
                <div class="card-info">ğŸ“ ${c.phone || 'ç„¡é›»è©±'}</div>
                <div class="card-info">ğŸ“… ä¸Šæ¬¡è¯çµ¡ï¼š${c.lastContactDate || 'æœªæœ‰ç´€éŒ„'}</div>
            </div>
        `).join('');
    }

    // --- Modal Logic ---
    function setPriority(p) {
        tempPriority = p;
        document.getElementById('p-Urgent').classList.toggle('active', p === 'Urgent');
        document.getElementById('p-Normal').classList.toggle('active', p === 'Normal');
    }

    function setCaseType(t) {
        tempCaseType = t;
        document.getElementById('t-Counselling').classList.toggle('active', t === 'Counselling');
        document.getElementById('t-Hidden').classList.toggle('active', t === 'Hidden');
    }

    function setLogContactType(lt) {
        tempLogContactType = lt;
        document.getElementById('lt-Phone').classList.toggle('active', lt === 'Phone');
        document.getElementById('lt-InPerson').classList.toggle('active', lt === 'InPerson');
    }

    function openAddModal() {
        document.getElementById('edit-id').value = '';
        document.getElementById('modal-header-title').innerText = "æ–°å¢å€‹æ¡ˆ";
        document.getElementById('f-name').value = '';
        document.getElementById('f-phone').value = '';
        document.getElementById('f-last-date').value = new Date().toLocaleDateString();
        document.getElementById('f-notes').value = '';
        document.getElementById('modal-log-list').innerHTML = '';
        setPriority('Normal');
        setCaseType('Counselling');
        resetLogEditor();
        document.getElementById('archive-btn').style.display = 'none';
        document.getElementById('case-modal').style.display = 'flex';
    }

    function openEditModal(id) {
        const c = cases.find(x => x.id === id);
        document.getElementById('edit-id').value = c.id;
        document.getElementById('modal-header-title').innerText = "ç·¨è¼¯å€‹æ¡ˆ: " + c.name;
        document.getElementById('f-name').value = c.name;
        document.getElementById('f-phone').value = c.phone;
        document.getElementById('f-last-date').value = c.lastContactDate;
        document.getElementById('f-notes').value = c.serviceNotes;
        
        setPriority(c.priority);
        setCaseType(c.caseType);
        renderModalLogList(c.contactLog);
        resetLogEditor();

        document.getElementById('archive-btn').style.display = 'block';
        document.getElementById('archive-btn').innerText = c.isClosed ? "â†©ï¸ é‡æ–°é–‹å•Ÿå€‹æ¡ˆ" : "ğŸ—‘ï¸ çµæ¡ˆ (Close Case)";
        document.getElementById('case-modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('case-modal').style.display = 'none'; }

    // --- Log Management ---
    function renderModalLogList(logs) {
        const container = document.getElementById('modal-log-list');
        container.innerHTML = logs.map((l, index) => `
            <div class="log-item ${l.type}" onclick="startEditLog(${index})">
                <div class="log-meta">
                    <span>${l.type === 'Phone' ? 'ğŸ“ é›»è©±' : 'ğŸ«‚ é¢è¦‹'} - ${new Date(l.timestamp).toLocaleString()}</span>
                    <span style="color:var(--primary); font-weight:bold;">âœ ä¿®æ”¹</span>
                </div>
                <div style="font-size:14px;">${l.note}</div>
            </div>
        `).reverse().join('');
    }

    function startEditLog(index) {
        const id = document.getElementById('edit-id').value;
        const c = cases.find(x => x.id === id);
        const log = c.contactLog[index];

        document.getElementById('edit-log-index').value = index;
        document.getElementById('log-text').value = log.note;
        setLogContactType(log.type);
        
        document.getElementById('log-editor-box').classList.add('editing');
        document.getElementById('btn-cancel-log').style.display = 'inline';
        document.getElementById('log-status-hint').innerText = "âš ï¸ æ­£åœ¨ç·¨è¼¯éå¾€ç´€éŒ„";
    }

    function resetLogEditor() {
        document.getElementById('edit-log-index').value = "-1";
        document.getElementById('log-text').value = "";
        setLogContactType('Phone');
        document.getElementById('log-editor-box').classList.remove('editing');
        document.getElementById('btn-cancel-log').style.display = 'none';
        document.getElementById('log-status-hint').innerText = "æ–°å¢ç´€éŒ„å¾Œæœƒè‡ªå‹•æ›´æ–°è¯çµ¡æ—¥æœŸ";
    }

    function saveLogEntry() {
        const id = document.getElementById('edit-id').value;
        if (!id) return alert("è«‹å…ˆå¡«å¯«ä¸Šæ–¹åŸºæœ¬è³‡æ–™ä¸¦å„²å­˜å€‹æ¡ˆ");

        const note = document.getElementById('log-text').value;
        const logIdx = parseInt(document.getElementById('edit-log-index').value);
        if (!note) return alert("è«‹è¼¸å…¥ç´€éŒ„å…§å®¹");

        const cIdx = cases.findIndex(x => x.id === id);
        if (logIdx === -1) {
            cases[cIdx].contactLog.push({ timestamp: new Date().toISOString(), note: note, type: tempLogContactType });
            cases[cIdx].lastContactDate = new Date().toLocaleDateString();
            document.getElementById('f-last-date').value = cases[cIdx].lastContactDate;
        } else {
            cases[cIdx].contactLog[logIdx].note = note;
            cases[cIdx].contactLog[logIdx].type = tempLogContactType;
        }

        saveToLocal();
        renderModalLogList(cases[cIdx].contactLog);
        renderCases();
        resetLogEditor();
    }

    // --- Case Persistence ---
    function saveFullCase() {
        const id = document.getElementById('edit-id').value;
        const data = {
            name: document.getElementById('f-name').value,
            phone: document.getElementById('f-phone').value,
            lastContactDate: document.getElementById('f-last-date').value,
            serviceNotes: document.getElementById('f-notes').value,
            priority: tempPriority,
            caseType: tempCaseType
        };

        if (!data.name) return alert("è«‹è¼¸å…¥é•·è€…å§“å");

        if (id) {
            const idx = cases.findIndex(x => x.id === id);
            cases[idx] = { ...cases[idx], ...data };
        } else {
            cases.push({ id: Date.now().toString(), ...data, isClosed: false, contactLog: [] });
        }

        saveToLocal();
        renderCases();
        closeModal();
    }

    function toggleArchiveStatus() {
        const id = document.getElementById('edit-id').value;
        const idx = cases.findIndex(x => x.id === id);
        cases[idx].isClosed = !cases[idx].isClosed;
        saveToLocal();
        renderCases();
        closeModal();
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Case Manager - Ultimate Integrated Version</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #007AFF; --success: #34c759; --warning: #ff9500; --danger: #ff3b30;
            --bg-gray: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-sec: #8e8e93;
            --alert-bg: #ffe2e6;
        }

        body { font-family: -apple-system, sans-serif; background-color: var(--bg-gray); margin: 0; padding-bottom: 50px; color: var(--text-main); }
        header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        
        .io-controls { background: #fff; padding: 10px 20px; display: flex; gap: 10px; border-bottom: 1px solid #e5e5ea; }
        .btn-io { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }

        .controls { background: white; padding: 10px 20px 5px 20px; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d1d6; box-sizing: border-box; margin-bottom: 10px; }
        
        /* çµ±è¨ˆçœ‹æ¿ */
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stats-box { background: #f8f9fa; border-radius: 12px; padding: 12px; text-align: center; border: 1px solid #e5e5ea; }
        .stats-val { display: block; font-size: 22px; font-weight: bold; color: var(--primary); }
        .stats-label { font-size: 11px; color: var(--text-sec); font-weight: bold; }

        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .filter-tag { padding: 6px 14px; border-radius: 15px; background: #eee; font-size: 13px; cursor: pointer; border: none; white-space: nowrap; transition: 0.2s; }
        .filter-tag.active { background: var(--primary); color: white; }

        #case-list { padding: 16px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; position: relative; border: 2px solid transparent; display: flex; align-items: center; }
        .card.pinned { border-color: #ffcc00; background: #fffdf0; }
        .card.urgent-alert { background-color: var(--alert-bg); border-color: #ffb3ba; }
        .card.closed { opacity: 0.6; background: #e5e5ea; }
        
        .card-content { flex: 1; }
        .card-right { display: flex; align-items: center; gap: 10px; }
        .countdown-box { text-align: center; min-width: 50px; }
        .countdown-num { font-size: 18px; font-weight: bold; }
        .countdown-label { font-size: 9px; color: var(--text-sec); text-transform: uppercase; }
        .countdown-alert .countdown-num { color: var(--danger); }

        .pin-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: #ccc; }
        .pin-btn.active { color: #ffcc00; }
        .case-number-tag { font-size: 11px; color: var(--primary); font-weight: bold; margin-bottom: 2px; }
        .tag-row { display: flex; gap: 5px; margin: 5px 0; }
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .urgent-tag { background: #ff3b3022; color: #ff3b30; }
        .normal-tag { background: #007AFF22; color: #007AFF; }

        .modal-overlay { position: fixed; top:0; left:0; width: 100%; height:100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 600px; height: 95%; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; color: var(--text-sec); margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 11px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .opt-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #f2f2f7; cursor: pointer; text-align: center; font-size: 13px; }
        .opt-btn.active { background: var(--primary); color: white; }
        .btn-full { width: 100%; padding: 16px; border-radius: 14px; font-weight: bold; cursor: pointer; border: none; margin-bottom: 12px; }
        
        .log-item { background: #f9f9fb; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #ddd; position: relative; }
        .log-edit-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--primary); cursor: pointer; font-size: 14px; }
        .log-date-badge { font-size: 11px; color: var(--text-sec); display: block; margin-bottom: 4px; }
        
        .btn-export-word { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 15px; cursor: pointer; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <h1>Case Manager</h1>
    <button style="background:none; border:none; color:var(--primary); font-size:30px; cursor:pointer;" onclick="openAddModal()">ï¼‹</button>
</header>

<div class="io-controls">
    <button class="btn-io" onclick="exportToExcel()">ğŸ“¤ å…¨é«”åŒ¯å‡º (Excel)</button>
    <button class="btn-io" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥è³‡æ–™ (å«ç´€éŒ„)</button>
    <input type="file" id="importFile" hidden accept=".xlsx" onchange="importFromExcel(event)">
</div>

<div class="controls">
    <input type="text" class="search-input" id="search-box" placeholder="ğŸ” æœå°‹ç·¨è™Ÿã€å§“å..." oninput="renderCases()">
    
    <div class="stats-container">
        <div class="stats-box">
            <span class="stats-val" id="stat-counselling">0</span>
            <span class="stats-label">ACTIVE è¼”å°å€‹æ¡ˆ</span>
        </div>
        <div class="stats-box">
            <span class="stats-val" id="stat-hidden">0</span>
            <span class="stats-label">ACTIVE éš±è”½å€‹æ¡ˆ</span>
        </div>
    </div>

    <div class="filter-bar">
        <button class="filter-tag active" onclick="setFilter('ALL', this)">å…¨éƒ¨</button>
        <button class="filter-tag" onclick="setFilter('Counselling', this)">ğŸ¤ è¼”å°</button>
        <button class="filter-tag" onclick="setFilter('Hidden', this)">ğŸ‘¤ éš±è”½</button>
        <button class="filter-tag" onclick="setFilter('Urgent', this)">ğŸ”´ ç·Šæ€¥</button>
        <button class="filter-tag" onclick="setFilter('Normal', this)">ğŸ”µ éç·Šæ€¥</button>
    </div>
</div>

<div id="case-list"></div>

<div class="modal-overlay" id="case-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h2 style="margin:0;">å€‹æ¡ˆè©³æƒ…</h2>
            <button onclick="closeModal()" style="border:none; background:none; color:var(--primary); font-weight:bold;">é—œé–‰</button>
        </div>
        
        <input type="hidden" id="internal-id">
        <input type="hidden" id="editing-log-index" value="-1">
        
        <div class="form-group">
            <label>å€‹æ¡ˆç‹€æ…‹</label>
            <div class="option-grid">
                <div class="opt-btn" id="st-Active" onclick="setCaseStatus('Active')">ğŸŸ¢ Active</div>
                <div class="opt-btn" id="st-Closed" onclick="setCaseStatus('Closed')">âšª Closed</div>
            </div>
        </div>

        <div class="form-group">
            <label>å„ªå…ˆç´š</label>
            <div class="option-grid">
                <div class="opt-btn" id="p-Urgent" onclick="setPriority('Urgent')">ğŸ”´ ç·Šæ€¥</div>
                <div class="opt-btn" id="p-Normal" onclick="setPriority('Normal')">ğŸ”µ éç·Šæ€¥</div>
            </div>
        </div>

        <div class="form-group"><label>å€‹æ¡ˆç·¨è™Ÿ</label><input type="text" id="f-case-no"></div>
        <div class="form-group"><label>é•·è€…å§“å</label><input type="text" id="f-name"></div>

        <div class="form-group">
            <label>å€‹æ¡ˆæ€§è³ª</label>
            <div class="option-grid">
                <div class="opt-btn" id="t-Counselling" onclick="setCaseType('Counselling')">ğŸ¤ è¼”å°</div>
                <div class="opt-btn" id="t-Hidden" onclick="setCaseType('Hidden')">ğŸ‘¤ éš±è”½</div>
            </div>
        </div>

        <div class="form-group">
            <label>æ–‡æª”å°å‡º</label>
            <button class="btn-export-word" onclick="exportToWordReport()">ğŸ“ åŒ¯å‡ºä¿è‰¯å±€æœå‹™è¨˜éŒ„è¡¨ (Word)</button>
        </div>

        <div style="background:#eee; height:1px; margin:20px 0;"></div>

        <div class="form-group" id="log-input-section">
            <label id="log-input-label">æ–°å¢è¯çµ¡ç´€éŒ„</label>
            <input type="date" id="log-date" style="margin-bottom:10px;">
            <div class="option-grid">
                <div class="opt-btn" id="lt-Phone" onclick="setLogType('Phone')">TC (é›»è©±)</div>
                <div class="opt-btn" id="lt-InPerson" onclick="setLogType('InPerson')">OI (é¢è¦‹)</div>
            </div>
            <textarea id="log-text" placeholder="ç´€éŒ„å…§å®¹..." rows="3"></textarea>
            <button id="save-log-btn" onclick="saveLogEntry()" style="width:100%; margin-top:10px; background:var(--success); color:white; border:none; padding:12px; border-radius:10px; font-weight:bold; cursor:pointer;">å„²å­˜ç´€éŒ„</button>
            <button id="cancel-edit-log-btn" onclick="cancelLogEdit()" style="width:100%; margin-top:5px; background:#eee; color:#666; border:none; padding:8px; border-radius:10px; display:none;">å–æ¶ˆä¿®æ”¹</button>
        </div>

        <div id="modal-log-list"></div>

        <div style="margin-top:30px;">
            <button class="btn-full" style="background:var(--primary); color:white;" onclick="saveFullCase()">å„²å­˜æ‰€æœ‰è³‡æ–™</button>
            <button class="btn-full" style="background:var(--warning); color:white;" onclick="showConfirm('close')">çµæŸå€‹æ¡ˆ</button>
            <center><button style="background:none; border:none; color:var(--danger); text-decoration:underline; cursor:pointer;" onclick="showConfirm('delete')">åˆªé™¤å€‹æ¡ˆ</button></center>
        </div>
    </div>
</div>

<script>
    let cases = JSON.parse(localStorage.getItem('elderly_cases_final')) || [];
    let tempStatus = 'Active', tempType = 'Counselling', tempLogType = 'Phone', tempPriority = 'Normal', currentFilter = 'ALL';

    window.onload = () => { renderCases(); };
    function saveToLocal() { localStorage.setItem('elderly_cases_final', JSON.stringify(cases)); }

    function updateStats() {
        const activeCases = cases.filter(c => c.status === 'Active');
        document.getElementById('stat-counselling').innerText = activeCases.filter(c => c.caseType === 'Counselling').length;
        document.getElementById('stat-hidden').innerText = activeCases.filter(c => c.caseType === 'Hidden').length;
    }

    function getRemainingDays(lastDateStr) {
        if (!lastDateStr) return null;
        const nextDate = new Date(lastDateStr);
        nextDate.setDate(nextDate.getDate() + 90);
        const diffTime = nextDate - new Date();
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // --- Word åŒ¯å‡º (20å­—æ›è¡Œ) ---
    function exportToWordReport() {
        const id = document.getElementById('internal-id').value;
        const c = cases.find(x => x.id === id);
        if (!c || c.contactLog.length === 0) return alert("å°šç„¡ç´€éŒ„å¯åŒ¯å‡º");

        let tableRows = c.contactLog.map(l => {
            let note = l.note || "";
            let formattedNote = "";
            for (let i = 0; i < note.length; i += 20) {
                formattedNote += note.substring(i, i + 20) + "<br>";
            }
            const typeLabel = l.type === 'Phone' ? 'TC' : 'OI';
            return `<tr>
                <td style="border:1px solid black; padding:5px;">${l.date}</td>
                <td style="border:1px solid black; padding:5px; text-align:center;">${typeLabel}</td>
                <td style="border:1px solid black; padding:5px;">æ¡ˆä¸»</td>
                <td style="border:1px solid black; padding:5px;">${formattedNote}</td>
                <td style="border:1px solid black; padding:5px;"></td>
            </tr>`;
        }).join('');

        const html = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'></head>
            <body>
                <h2 style="text-align:center;">ä¿è‰¯å±€å¼µæƒ èçš‡åå±±å–œæ‚¦è–ˆæœå‹™è¨˜éŒ„è¡¨</h2>
                <p>æ¡ˆä¸»å§“å: ${c.name} &nbsp;&nbsp;&nbsp; æª”æ¡ˆè™Ÿç¢¼: ${c.caseNo}</p>
                <table style="width:100%; border-collapse:collapse; border:1px solid black;">
                    <thead>
                        <tr style="background:#f2f2f2;">
                            <th style="border:1px solid black;">æ—¥æœŸ</th>
                            <th style="border:1px solid black;">æ–¹å¼</th>
                            <th style="border:1px solid black;">æ¥è§¸äºº/æ©Ÿæ§‹</th>
                            <th style="border:1px solid black;">è³‡æ–™/æœå‹™æä¾› (20å­—ä¸€è¡Œ)</th>
                            <th style="border:1px solid black;">å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
                <p style="font-size:10pt;">æ–¹å¼ï¼šTC=é›»è©±æ¥è§¸, OI=é¢è«‡, HV=å®¶è¨ª</p>
            </body></html>`;

        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${c.name}_æœå‹™è¨˜éŒ„è¡¨.doc`;
        link.click();
    }

    // --- ä¿®æ”¹/æ–°å¢ç´€éŒ„é‚è¼¯ ---
    function editLog(index) {
        const id = document.getElementById('internal-id').value;
        const c = cases.find(x => x.id === id);
        const log = c.contactLog[index];
        document.getElementById('editing-log-index').value = index;
        document.getElementById('log-date').value = log.date;
        document.getElementById('log-text').value = log.note;
        setLogType(log.type);
        document.getElementById('log-input-label').innerText = "ä¿®æ”¹ç´€éŒ„ä¸­...";
        document.getElementById('save-log-btn').innerText = "æ›´æ–°æ­¤ç­†ç´€éŒ„";
        document.getElementById('save-log-btn').style.background = "var(--warning)";
        document.getElementById('cancel-edit-log-btn').style.display = "block";
    }

    function cancelLogEdit() {
        document.getElementById('editing-log-index').value = "-1";
        document.getElementById('log-text').value = "";
        document.getElementById('log-date').valueAsDate = new Date();
        document.getElementById('log-input-label').innerText = "æ–°å¢è¯çµ¡ç´€éŒ„";
        document.getElementById('save-log-btn').innerText = "å„²å­˜ç´€éŒ„";
        document.getElementById('save-log-btn').style.background = "var(--success)";
        document.getElementById('cancel-edit-log-btn').style.display = "none";
    }

    function saveLogEntry() {
        const id = document.getElementById('internal-id').value;
        const note = document.getElementById('log-text').value;
        const date = document.getElementById('log-date').value;
        const editIdx = parseInt(document.getElementById('editing-log-index').value);
        if(!id) return alert("è«‹å…ˆä¿å­˜å€‹æ¡ˆåŸºæœ¬è³‡æ–™");
        if(!note || !date) return alert("è«‹å¡«å¯«å…§å®¹");
        const idx = cases.findIndex(x => x.id === id);
        if (editIdx > -1) {
            cases[idx].contactLog[editIdx] = { date, note, type: tempLogType };
        } else {
            cases[idx].contactLog.push({ date, note, type: tempLogType });
        }
        cases[idx].lastContactDate = cases[idx].contactLog.reduce((max, p) => p.date > max ? p.date : max, "");
        saveToLocal();
        renderLogs(cases[idx].contactLog);
        renderCases();
        cancelLogEdit();
    }

    // --- Excel åŒ¯å…¥/å°å‡º ---
    function exportToExcel() {
        if (cases.length === 0) return alert("ç„¡è³‡æ–™");
        let rows = [];
        cases.forEach(c => {
            if (c.contactLog && c.contactLog.length > 0) {
                c.contactLog.forEach(log => {
                    rows.push({ "å€‹æ¡ˆç·¨è™Ÿ": c.caseNo, "å§“å": c.name, "ç‹€æ…‹": c.status, "å„ªå…ˆç´š": c.priority, "æ€§è³ª": c.caseType, "ç´€éŒ„æ—¥æœŸ": log.date, "ç´€éŒ„å…§å®¹": log.note, "è¯çµ¡æ–¹å¼": log.type === 'Phone' ? 'TC' : 'OI' });
                });
            } else {
                rows.push({ "å€‹æ¡ˆç·¨è™Ÿ": c.caseNo, "å§“å": c.name, "ç‹€æ…‹": c.status, "å„ªå…ˆç´š": c.priority, "æ€§è³ª": c.caseType, "ç´€éŒ„æ—¥æœŸ": "ç„¡", "ç´€éŒ„å…§å®¹": "ç„¡", "è¯çµ¡æ–¹å¼": "-" });
            }
        });
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å…¨é«”ç´€éŒ„");
        XLSX.writeFile(wb, `Cases_Export.xlsx`);
    }

    function importFromExcel(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            json.forEach(row => {
                const caseNo = String(row["å€‹æ¡ˆç·¨è™Ÿ"] || "").trim();
                if (!caseNo) return;
                let target = cases.find(c => c.caseNo === caseNo);
                if (!target) {
                    target = { id: Date.now().toString() + Math.random(), caseNo, name: row["å§“å"], status: row["ç‹€æ…‹"] || "Active", priority: row["å„ªå…ˆç´š"] || "Normal", caseType: row["æ€§è³ª"] || "Counselling", contactLog: [], lastContactDate: "", isPinned: false };
                    cases.push(target);
                }
                if (row["ç´€éŒ„æ—¥æœŸ"] && row["ç´€éŒ„æ—¥æœŸ"] !== "ç„¡") {
                    const isDup = target.contactLog.some(l => l.date === String(row["ç´€éŒ„æ—¥æœŸ"]) && l.note === String(row["ç´€éŒ„å…§å®¹"]));
                    if (!isDup) target.contactLog.push({ date: String(row["ç´€éŒ„æ—¥æœŸ"]), note: String(row["ç´€éŒ„å…§å®¹"]), type: (row["è¯çµ¡æ–¹å¼"] === 'OI') ? "InPerson" : "Phone" });
                }
                target.lastContactDate = target.contactLog.reduce((max, p) => p.date > max ? p.date : max, "");
            });
            saveToLocal(); renderCases(); alert("åŒ¯å…¥æˆåŠŸ"); event.target.value = "";
        };
        reader.readAsArrayBuffer(file);
    }

    // --- UI æ¸²æŸ“èˆ‡éæ¿¾ ---
    function renderCases() {
        updateStats();
        const list = document.getElementById('case-list');
        const search = document.getElementById('search-box').value.toLowerCase();
        let filtered = cases.filter(c => {
            const matches = (c.name || "").toLowerCase().includes(search) || (c.caseNo || "").toLowerCase().includes(search);
            if (currentFilter === 'ALL') return matches;
            return matches && (c.caseType === currentFilter || c.priority === currentFilter);
        });
        filtered.sort((a,b) => (!!a.isPinned !== !!b.isPinned ? (a.isPinned ? -1 : 1) : (a.status === 'Active' ? -1 : 1)));
        list.innerHTML = filtered.map(c => {
            const daysLeft = getRemainingDays(c.lastContactDate);
            const isAlert = daysLeft !== null && daysLeft < 15;
            return `<div class="card ${c.status === 'Closed' ? 'closed' : ''} ${c.isPinned ? 'pinned' : ''} ${isAlert && c.status === 'Active' ? 'urgent-alert' : ''}" onclick="openEditModal('${c.id}')">
                <div class="card-content">
                    <div class="case-number-tag">${c.caseNo}</div>
                    <div style="font-weight:bold; font-size:18px;">${c.name}</div>
                    <div class="tag-row">
                        <span class="tag ${c.priority === 'Urgent' ? 'urgent-tag' : 'normal-tag'}">${c.priority === 'Urgent' ? 'ğŸ”´ ç·Šæ€¥' : 'ğŸ”µ éç·Šæ€¥'}</span>
                        <span class="tag" style="background:#eee;">${c.caseType === 'Hidden' ? 'ğŸ‘¤ éš±è”½' : 'ğŸ¤ è¼”å°'}</span>
                    </div>
                </div>
                <div class="card-right">
                    <div class="countdown-box ${isAlert ? 'countdown-alert' : ''}"><span class="countdown-num">${daysLeft === null ? 'éœ€è¯çµ¡' : daysLeft}</span><span class="countdown-label">Days</span></div>
                    <button class="pin-btn ${c.isPinned ? 'active' : ''}" onclick="togglePin(event, '${c.id}')">ğŸ“Œ</button>
                </div>
            </div>`;
        }).join('');
    }

    function openEditModal(id) {
        const c = cases.find(x => x.id === id);
        document.getElementById('internal-id').value = c.id;
        document.getElementById('f-case-no').value = c.caseNo;
        document.getElementById('f-name').value = c.name;
        setCaseStatus(c.status); setCaseType(c.caseType); setPriority(c.priority);
        renderLogs(c.contactLog); cancelLogEdit();
        document.getElementById('case-modal').style.display = 'flex';
    }

    function renderLogs(logs) {
        document.getElementById('modal-log-list').innerHTML = (logs || []).map((l, idx) => `
            <div class="log-item">
                <button class="log-edit-btn" onclick="editLog(${idx})">âœï¸</button>
                <span class="log-date-badge">${l.date} | ${l.type === 'Phone' ? 'TC' : 'OI'}</span>
                <div style="white-space: pre-wrap;">${l.note}</div>
            </div>`).reverse().join('');
    }

    // --- è¼”åŠ©å‡½æ•¸ ---
    function setPriority(p) { tempPriority = p; document.getElementById('p-Urgent').classList.toggle('active', p==='Urgent'); document.getElementById('p-Normal').classList.toggle('active', p==='Normal'); }
    function setCaseStatus(s) { tempStatus = s; document.getElementById('st-Active').classList.toggle('active', s==='Active'); document.getElementById('st-Closed').classList.toggle('active', s==='Closed'); }
    function setCaseType(t) { tempType = t; document.getElementById('t-Counselling').classList.toggle('active', t==='Counselling'); document.getElementById('t-Hidden').classList.toggle('active', t==='Hidden'); }
    function setLogType(lt) { tempLogType = lt; document.getElementById('lt-Phone').classList.toggle('active', lt==='Phone'); document.getElementById('lt-InPerson').classList.toggle('active', lt==='InPerson'); }
    function openAddModal() { document.getElementById('internal-id').value = ''; document.getElementById('f-case-no').value = ''; document.getElementById('f-name').value = ''; setCaseStatus('Active'); setCaseType('Counselling'); setPriority('Normal'); renderLogs([]); document.getElementById('case-modal').style.display = 'flex'; }
    function saveFullCase() { const id = document.getElementById('internal-id').value; const data = { caseNo: document.getElementById('f-case-no').value, name: document.getElementById('f-name').value, status: tempStatus, caseType: tempType, priority: tempPriority }; if(id) { const i = cases.findIndex(x => x.id === id); cases[i] = {...cases[i], ...data}; } else { cases.push({id: Date.now().toString(), ...data, contactLog: [], lastContactDate: '', isPinned: false}); } saveToLocal(); renderCases(); closeModal(); }
    function closeModal() { document.getElementById('case-modal').style.display = 'none'; }
    function togglePin(e, id) { e.stopPropagation(); const idx = cases.findIndex(x => x.id === id); cases[idx].isPinned = !cases[idx].isPinned; saveToLocal(); renderCases(); }
    function setFilter(filter, btn) { currentFilter = filter; document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderCases(); }
    function showConfirm(action) { const id = document.getElementById('internal-id').value; if(action==='delete' && confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { cases = cases.filter(x => x.id !== id); saveToLocal(); renderCases(); closeModal(); } else if(action==='close') { const i = cases.findIndex(x => x.id === id); cases[i].status = 'Closed'; saveToLocal(); renderCases(); closeModal(); } }
</script>
</body>
</html>

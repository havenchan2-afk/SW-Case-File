<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Case Manager - Enhanced</title>
    <style>
        :root {
            --primary: #007AFF;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --bg-gray: #f2f2f7;
            --card-bg: #ffffff;
            --text-main: #1c1c1e;
            --text-sec: #8e8e93;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-gray);
            margin: 0; padding-bottom: 50px;
        }

        /* UI å…ƒä»¶æ¨£å¼ */
        header { background: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 22px; }
        .controls { background: white; padding: 10px 20px; border-top: 1px solid #e5e5ea; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d1d6; margin-bottom: 10px; box-sizing: border-box; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        #case-list { padding: 16px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; }
        .card.pinned { border: 2px solid #ffcc00; background: #fffbe6; }
        
        /* Modal å½ˆçª—æ¨£å¼ */
        .modal-overlay { position: fixed; top:0; left:0; width: 100%; height:100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 600px; height: 90%; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        
        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; color: var(--text-sec); margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; box-sizing: border-box; }

        /* --- æ—¥èªŒå°ˆç”¨æ¨£å¼ --- */
        .log-section { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 20px; border: 1px solid #eee; }
        .log-input-area { background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; }
        
        .type-selector { display: flex; gap: 10px; margin-bottom: 10px; }
        .type-btn { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ddd; background: #f2f2f7; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .type-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }

        .log-list { margin-top: 10px; max-height: 300px; overflow-y: auto; }
        .log-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #ddd; position: relative; cursor: pointer; }
        .log-item:hover { background: #f0f7ff; }
        .log-item.phone { border-left-color: #4da6ff; }
        .log-item.visit { border-left-color: #ff7f50; }
        .log-meta { font-size: 11px; color: var(--text-sec); display: flex; justify-content: space-between; margin-bottom: 4px; }
        .edit-badge { color: var(--primary); font-weight: bold; font-size: 10px; }

        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-log-add { background: var(--success); color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; }
        .editing-mode { border: 2px solid var(--warning) !important; }
    </style>
</head>
<body>

<header>
    <h1>Case Manager</h1>
    <button style="background:none; border:none; color:var(--primary); font-size:24px;" onclick="openAddModal()">ï¼‹</button>
</header>

<div class="controls">
    <input type="text" class="search-input" id="search-box" placeholder="ğŸ” æœå°‹å§“å..." oninput="renderCases()">
</div>

<div id="case-list"></div>

<div class="modal-overlay" id="case-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="modal-title">å€‹æ¡ˆè³‡æ–™</h2>
            <button onclick="closeModal()" style="border:none; background:none; color:var(--primary);">é—œé–‰</button>
        </div>

        <input type="hidden" id="edit-id">
        
        <div class="form-group">
            <label>é•·è€…å§“å</label>
            <input type="text" id="f-name">
        </div>
        <div class="form-group">
            <label>ä¸Šæ¬¡è¯çµ¡æ—¥æœŸ (æ‰‹å‹•æ›´æ–°)</label>
            <input type="text" id="f-last-date">
        </div>

        <div class="log-section">
            <h3 id="log-editor-title">æ–°å¢æœå‹™ç´€éŒ„</h3>
            
            <div class="log-input-area" id="log-input-box">
                <input type="hidden" id="edit-log-index" value="-1">
                <div class="type-selector">
                    <button class="type-btn active" id="btn-type-phone" onclick="setLogType('Phone')">ğŸ“ é›»è©±è¯çµ¡</button>
                    <button class="type-btn" id="btn-type-visit" onclick="setLogType('InPerson')">ğŸ«‚ å¯¦é«”é¢è¦‹</button>
                </div>
                <textarea id="new-log-text" placeholder="è¼¸å…¥ç´€éŒ„å…§å®¹..." rows="3" style="margin-bottom:10px;"></textarea>
                <div style="display:flex; justify-content: space-between; align-items:center;">
                    <span id="log-hint" style="font-size:11px; color:var(--text-sec);">é»æ“Šä¸‹æ–¹èˆŠç´€éŒ„å¯é€²è¡Œä¿®æ”¹</span>
                    <div>
                        <button class="btn-log-add" id="save-log-btn" onclick="saveLogEntry()">å„²å­˜ç´€éŒ„</button>
                        <button id="cancel-log-edit" onclick="resetLogEditor()" style="display:none; padding:8px; border:none; background:none; color:var(--danger);">å–æ¶ˆä¿®æ”¹</button>
                    </div>
                </div>
            </div>

            <label>éå¾€ç´€éŒ„ (é»æ“Šå¯ç·¨è¼¯)</label>
            <div class="log-list" id="log-list"></div>
        </div>

        <button class="btn-main" onclick="saveCaseData()">å„²å­˜å€‹æ¡ˆè®Šæ›´</button>
    </div>
</div>

<script>
    let cases = JSON.parse(localStorage.getItem('elderly_cases')) || [];
    let currentLogType = 'Phone';

    // åˆå§‹åŒ–
    window.onload = renderCases;

    function saveToLocal() {
        localStorage.setItem('elderly_cases', JSON.stringify(cases));
    }

    function renderCases() {
        const list = document.getElementById('case-list');
        const search = document.getElementById('search-box').value.toLowerCase();
        
        const filtered = cases.filter(c => c.name.toLowerCase().includes(search));
        
        list.innerHTML = filtered.map(c => `
            <div class="card" onclick="openEditModal('${c.id}')">
                <div style="font-weight:bold; font-size:18px;">${c.name}</div>
                <div style="font-size:13px; color:#666; margin-top:5px;">ğŸ“… ä¸Šæ¬¡è¯çµ¡: ${c.lastContactDate || 'æœªæœ‰ç´€éŒ„'}</div>
                <div style="font-size:13px; color:#999;">ğŸ“ ç´€éŒ„ï¼š${c.contactLog.length} æ¢</div>
            </div>
        `).join('');
    }

    function openAddModal() {
        document.getElementById('edit-id').value = '';
        document.getElementById('f-name').value = '';
        document.getElementById('f-last-date').value = new Date().toLocaleDateString();
        document.getElementById('log-list').innerHTML = '';
        resetLogEditor();
        document.getElementById('case-modal').style.display = 'flex';
    }

    function openEditModal(id) {
        const c = cases.find(x => x.id === id);
        document.getElementById('edit-id').value = c.id;
        document.getElementById('f-name').value = c.name;
        document.getElementById('f-last-date').value = c.lastContactDate;
        
        renderLogList(c.contactLog);
        resetLogEditor();
        document.getElementById('case-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('case-modal').style.display = 'none';
    }

    // --- æ—¥èªŒé‚è¼¯ ---

    function setLogType(type) {
        currentLogType = type;
        document.getElementById('btn-type-phone').classList.toggle('active', type === 'Phone');
        document.getElementById('btn-type-visit').classList.toggle('active', type === 'InPerson');
    }

    function renderLogList(logs) {
        const container = document.getElementById('log-list');
        container.innerHTML = logs.map((l, index) => `
            <div class="log-item ${l.type === 'Phone' ? 'phone' : 'visit'}" onclick="startEditLog(${index})">
                <div class="log-meta">
                    <span>${l.type === 'Phone' ? 'ğŸ“ é›»è©±' : 'ğŸ«‚ é¢è¦‹'} - ${new Date(l.timestamp).toLocaleString()}</span>
                    <span class="edit-badge">âœ é»æ“Šä¿®æ”¹</span>
                </div>
                <div style="font-size:14px;">${l.note}</div>
            </div>
        `).reverse().join('');
    }

    function startEditLog(index) {
        const id = document.getElementById('edit-id').value;
        const c = cases.find(x => x.id === id);
        const log = c.contactLog[index];

        document.getElementById('log-editor-title').innerText = "æ­£åœ¨ä¿®æ”¹ç´€éŒ„";
        document.getElementById('edit-log-index').value = index;
        document.getElementById('new-log-text').value = log.note;
        setLogType(log.type);
        
        document.getElementById('log-input-box').classList.add('editing-mode');
        document.getElementById('cancel-log-edit').style.display = 'inline';
        document.getElementById('save-log-btn').innerText = "ç¢ºèªä¿®æ”¹";
        document.getElementById('log-hint').innerText = "âš ï¸ æ­£åœ¨ç·¨è¼¯æ¨¡å¼";
    }

    function resetLogEditor() {
        document.getElementById('log-editor-title').innerText = "æ–°å¢æœå‹™ç´€éŒ„";
        document.getElementById('edit-log-index').value = "-1";
        document.getElementById('new-log-text').value = "";
        setLogType('Phone');
        document.getElementById('log-input-box').classList.remove('editing-mode');
        document.getElementById('cancel-log-edit').style.display = 'none';
        document.getElementById('save-log-btn').innerText = "å„²å­˜ç´€éŒ„";
        document.getElementById('log-hint').innerText = "é»æ“Šä¸‹æ–¹èˆŠç´€éŒ„å¯é€²è¡Œä¿®æ”¹";
    }

    function saveLogEntry() {
        const id = document.getElementById('edit-id').value;
        if (!id) return alert("è«‹å…ˆå¡«å¯«ä¸¦å„²å­˜å€‹æ¡ˆåŸºæœ¬è³‡æ–™");

        const note = document.getElementById('new-log-text').value;
        const logIndex = parseInt(document.getElementById('edit-log-index').value);
        if (!note) return alert("è«‹è¼¸å…¥ç´€éŒ„å…§å®¹");

        const cIdx = cases.findIndex(x => x.id === id);
        
        if (logIndex === -1) {
            // æ–°å¢
            cases[cIdx].contactLog.push({
                timestamp: new Date().toISOString(),
                note: note,
                type: currentLogType
            });
            // è‡ªå‹•æ›´æ–°æœ€æ–°è¯çµ¡æ—¥æœŸ
            cases[cIdx].lastContactDate = new Date().toLocaleDateString();
            document.getElementById('f-last-date').value = cases[cIdx].lastContactDate;
        } else {
            // ä¿®æ”¹
            cases[cIdx].contactLog[logIndex].note = note;
            cases[cIdx].contactLog[logIndex].type = currentLogType;
            // å¯é¸æ“‡æ˜¯å¦æ›´æ–°ä¿®æ”¹æ™‚é–“ï¼Œé€™è£¡ä¿æŒåŸç´€éŒ„æ™‚é–“ï¼Œåƒ…ä¿®æ”¹å…§å®¹
        }

        saveToLocal();
        renderLogList(cases[cIdx].contactLog);
        renderCases();
        resetLogEditor();
    }

    function saveCaseData() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('f-name').value;
        const date = document.getElementById('f-last-date').value;

        if (!name) return alert("è«‹è¼¸å…¥å§“å");

        if (id) {
            const idx = cases.findIndex(x => x.id === id);
            cases[idx].name = name;
            cases[idx].lastContactDate = date;
        } else {
            cases.push({
                id: Date.now().toString(),
                name: name,
                lastContactDate: date,
                contactLog: []
            });
        }

        saveToLocal();
        renderCases();
        closeModal();
    }
</script>

</body>
</html>
